<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Optimizer - v11.01</title>

    <!-- üîë ÂÖ®Â±ÄÁâàÊú¨ÊéßÂà∂ - ‰øÆÊîπÊ≠§ÂÄºÂº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÁºìÂ≠ò -->
    <script>
        window.APP_VERSION = '2026.01.04.003';
        window.APP_CONFIG = {
            // CDN Fallback URLs
            CDN_REACT: 'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js',
            CDN_REACT_DOM: 'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js',
            // ‰∏∫ URL Ê∑ªÂä†ÁâàÊú¨Êü•ËØ¢Â≠óÁ¨¶‰∏≤ÔºàÁî®‰∫éÁºìÂ≠òÂ§±ÊïàÔºâ
            withVersion: function (url) {
                if (!url) return url;
                const separator = url.includes('?') ? '&' : '?';
                return url + separator + 'v=' + window.APP_VERSION;
            }
        };

        // ÁºìÂ≠òÁâàÊú¨Ê£ÄÊü•
        (function () {
            const storedVersion = localStorage.getItem('APP_VERSION');
            if (storedVersion && storedVersion !== window.APP_VERSION) {
                console.log('üîÑ Ê£ÄÊµãÂà∞ÁâàÊú¨Êõ¥Êñ∞ÔºåÊ∏ÖÁêÜÁºìÂ≠ò...');
            }
            localStorage.setItem('APP_VERSION', window.APP_VERSION);
        })();
    </script>

    <!-- React with SRI (Subresource Integrity) -->
    <!-- React with SRI (Removed temporarily) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- ‚úÖ Babel Â∑≤ÁßªÈô§ - JSX Â∑≤È¢ÑÁºñËØë‰∏∫ React.createElement -->

    <!-- Tailwind CSS - ÂÜÖËÅîÂÖ≥ÈîÆÊ†∑Âºè + CDN fallback -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style type="text/tailwindcss">
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', system-ui, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
            border: 1px solid #0f172a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .matrix-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: #020617;
            isolation: isolate;
        }

        .header-row {
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            height: 36px;
            background: #1e293b;
            border-bottom: 1px solid #475569;
        }

        .header-cell {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #cbd5e1;
            border-right: 1px solid #334155;
            cursor: grab;
            background: #1e293b;
            padding: 0 4px;
            text-align: center;
            line-height: 1.2;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .year-col-container {
            position: sticky;
            left: 0;
            z-index: 40;
            width: 60px;
            background: #0f172a;
            border-right: 1px solid #334155;
        }

        .data-row {
            position: absolute;
            display: flex;
            width: 100%;
            border-bottom: 1px solid #1e293b;
        }

        .data-cell {
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            padding: 1px;
            gap: 1px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        .regime-block {
            flex: 1;
            height: 100%;
            border-radius: 1px;
            font-size: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            cursor: help;
            color: #fff;
            transition: transform 0.1s;
        }

        .regime-block:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        }

        .btn {
            @apply px-3 py-1.5 rounded text-xs font-bold transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm;
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/20;
        }

        .btn-accent {
            @apply bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-900/20;
        }

        .btn-success {
            @apply bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-900/20;
        }

        .btn-purple {
            @apply bg-purple-600 hover:bg-purple-500 text-white shadow-purple-900/20;
        }

        .btn-danger {
            @apply bg-rose-600 hover:bg-rose-500 text-white shadow-rose-900/20;
        }

        .btn-dark {
            @apply bg-slate-700 hover:bg-slate-600 text-slate-200 border border-slate-600;
        }
    </style>
</head>

<body>
    <div id="root" class="h-screen w-screen flex flex-col"></div>

    <script>
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const h = React.createElement; // Alias for manual React
        const Fragment = React.Fragment;

        const CONFIG = {
            MIN_YEAR: -2070,
            MAX_YEAR: 2025,
            ROW_HEIGHT: 24,
            COL_WIDTH: 100
        };



        // [New] ÁßªÊ§çËá™ panorama.html ÁöÑÈ´òÁ∫ßÈ¢úËâ≤ÈÄªËæë
        const calcColor = (code) => {
            if (!code) return '#334155';
            const strCode = String(code);
            let originDigit = '1';
            let eraDigit = 4;
            if (/^\d/.test(strCode)) {
                originDigit = strCode.charAt(0);
                eraDigit = 5;
            } else {
                originDigit = strCode.length >= 3 ? strCode.charAt(2) : '1';
                eraDigit = parseInt(strCode.length >= 2 ? strCode.charAt(1) : '4') || 4;
            }
            const hueMap = { '1': 0, '5': 35, '6': 80, '2': 125, '3': 170, '7': 210, '8': 245, '4': 280, '9': 320, '0': 0 };
            const baseHue = hueMap[originDigit] !== undefined ? hueMap[originDigit] : 0;

            let hash = 0;
            for (let i = 0; i < strCode.length; i++) hash = strCode.charCodeAt(i) + ((hash << 5) - hash);
            hash = Math.abs(hash);

            const hueShift = (hash % 2 === 0) ? -6 : 6;
            let h = baseHue + hueShift;
            let l = 30 + (eraDigit * 5.0);
            l = Math.max(35, Math.min(65, l)); // Á®çÂæÆÊèê‰∫Æ‰∏ÄÁÇπÈÄÇÂ∫îÊ∑±Ëâ≤ËÉåÊôØ
            const baseSat = 45 + (eraDigit * 5);
            const satJitter = (hash % 16) - 8;
            let s = Math.max(30, Math.min(95, baseSat + satJitter));

            if (originDigit === '0') return `hsl(0, 0%, ${l}%)`;
            if (originDigit === '6') { l -= 10; s -= 5; }

            return `hsl(${h}, ${s}%, ${l}%)`;
        };

        // [New] ÁÆÄÊòì Hash ÂáΩÊï∞
        const simpleHash = (str) => { let h = 5381; for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i); return (h >>> 0).toString(36); };

        // [Optimization] Ê†∏ÂøÉÁÆóÊ≥ïÂ∑≤ËøÅÁßªËá≥ Web Worker (layout-worker.js) ‰ª•ÈÅøÂÖçÈòªÂ°û‰∏ªÁ∫øÁ®ã UI„ÄÇ
        // - AdvancedColumnSorter: Ë¥üË¥£ TSP ÂàóÊéíÂ∫è
        // - GlobalSequenceOptimizer: Ë¥üË¥£ÊîøÊùÉÂ∫èÂàóÂØπÈΩê


        // --- App ---
        function App() {
            const [data, setData] = useState(null);
            const [colOrder, setColOrder] = useState([]);
            const [cellLayout, setCellLayout] = useState({});
            const [masterSeqs, setMasterSeqs] = useState(null); // Â≠òÂÇ®‰∏ªÂ∫èÂàóË°®

            const [status, setStatus] = useState('idle');
            const [tspBestScore, setTspBestScore] = useState(0); // ËÆ∞ÂΩï TSP ÂéÜÂè≤ÊúÄÈ´òÂàÜ
            const [logs, setLogs] = useState(['Á≠âÂæÖ CSV...']);
            const [isFlipped, setIsFlipped] = useState(false); // [New] ÁøªËΩ¨Áä∂ÊÄÅ
            const [layoutScore, setLayoutScore] = useState(0); // [New] Â∏ÉÂ±ÄÂàÜÊï∞
            const [draggedCol, setDraggedCol] = useState(null); // [New] ÊãñÊãΩÂàóÁ¥¢Âºï
            const [dataHash, setDataHash] = useState(null); // [New] Êï∞ÊçÆÊåáÁ∫π

            const fileInputRef = useRef();
            const logEndRef = useRef();
            const gridRef = useRef();
            const stopRef = useRef(false);
            const [scrollTop, setScrollTop] = useState(0);
            const [viewportH, setViewportH] = useState(800);
            const [scrollLeft, setScrollLeft] = useState(0);  // XËΩ¥ËôöÊãüÂåñ
            const [viewportW, setViewportW] = useState(1200); // XËΩ¥ËôöÊãüÂåñ
            const ticking = useRef(false); // [New] Scroll RAF ticking
            const workerRef = useRef(null); // [New] Worker Reference
            const dataRef = useRef(null);
            useEffect(() => { dataRef.current = data; }, [data]);

            const generateCellLayout = (seqs, explicitData = null) => {
                // fix: parseContent Êó∂ setData Â∞öÊú™ÁîüÊïàÔºåÈúÄÊîØÊåÅ‰º†ÂÖ• explicitData
                const d = explicitData || dataRef.current || data;
                if (!d || !d.grid) return {};

                const layout = {};
                d.regions.forEach(id => {
                    layout[id] = {};
                    const master = seqs[id] || [];
                    for (let y = CONFIG.MIN_YEAR; y <= CONFIG.MAX_YEAR; y++) {
                        const set = d.grid[id]?.[y];
                        if (set) {
                            layout[id][y] = master.filter(r => set.has(r));
                        } else {
                            layout[id][y] = [];
                        }
                    }
                });
                return layout;
            };

            // [New] Serialization Helpers for Worker (Set -> Array)
            const prepareGrid = (grid, regions) => {
                const newGrid = {};
                regions.forEach(r => {
                    newGrid[r] = {};
                    if (grid[r]) {
                        Object.keys(grid[r]).forEach(y => {
                            const val = grid[r][y];
                            newGrid[r][y] = (val instanceof Set) ? Array.from(val) : val;
                        })
                    }
                });
                return newGrid;
            };

            const prepareWorkerData = (d) => {
                if (!d || !d.grid) return d;
                // Reuse logic or just call prepareGrid if grid is isolated
                const safeGrid = prepareGrid(d.grid, d.regions);
                return { ...d, grid: safeGrid };
            };

            // [New] Worker Handler
            const onWorkerMessage = (e) => {
                const { type, msg, score, layout, iter, tspScore, layScore, colOrder: newColOrder, masterSeqs: newMasterSeqs } = e.data;
                if (type === 'LOG') {
                    addLog(msg);
                }
                else if (type === 'QUICK_SCORE_RESULT') {
                    setTspBestScore(Math.floor(tspScore));
                    setLayoutScore(Math.floor(layScore));
                }
                else if (type === 'PROGRESS_TSP') {
                    setTspBestScore(Math.floor(score));
                }
                else if (type === 'RESULT_TSP') {
                    setColOrder(newColOrder);
                    setTspBestScore(Math.floor(score));
                }
                else if (type === 'PROGRESS_LAY') {
                    // Save progress constantly so hard-stop is safe
                    // [Fix] Use 'layout' (Strings) instead of 'masterSeqs' (Ints) for state
                    setMasterSeqs(layout);
                    const renderable = generateCellLayout(layout);
                    setCellLayout(renderable);
                    setLayoutScore(Math.floor(score));

                    // Log progress peri√≥dically (5000 iters)
                    if (iter && iter % 5000 === 0) {
                        addLog(`[LayOpt] Ëø≠‰ª£ ${iter} / ${500000}... Score: ${Math.floor(score)}`);
                    }
                }
                else if (type === 'RESULT_FINAL') {
                    setColOrder(newColOrder);
                    // [Fix] Use 'layout' (Strings) instead of 'masterSeqs' (Ints) for state
                    setMasterSeqs(layout);
                    const renderable = generateCellLayout(layout);
                    setCellLayout(renderable);
                    setLayoutScore(Math.floor(score));
                    setTspBestScore(Math.floor(tspScore));
                    setStatus('ready');
                    addLog(`‚úÖ Ê∑±Â∫¶‰ºòÂåñÂÆåÊØï„ÄÇFinal Score: ${Math.floor(score)}`);
                }
                else if (type === 'RESULT_LAY_DONE') {
                    console.log('Main: RESULT_LAY_DONE', layout);
                    // [Fix] Use 'layout' (Strings) instead of 'newMasterSeqs' (Ints)
                    setMasterSeqs(layout);
                    const renderable = generateCellLayout(layout);
                    setCellLayout(renderable);
                    setLayoutScore(Math.floor(score));
                    setStatus('ready');
                    addLog(`‚úÖ Â∏ÉÂ±Ä‰ºòÂåñÂÆåÊØï„ÄÇFinal Score: ${Math.floor(score)}`);
                }
                else if (type === 'WORKER_DONE') {
                    setStatus('ready');
                }
                else if (type === 'ERROR') {
                    addLog(`‚ùå Worker Error: ${msg}`);
                    console.error(msg);
                    setStatus('ready');
                }
            };

            const initWorker = () => {
                if (workerRef.current) workerRef.current.terminate();
                workerRef.current = new Worker('layout-worker.js?v=' + window.APP_VERSION);
                workerRef.current.onmessage = onWorkerMessage;
            };

            // [New] Worker Initialization
            useEffect(() => {
                initWorker();
                return () => workerRef.current?.terminate();
            }, []); // Fix: Worker should persist across data updates



            // [New] Manual Sequence Adjustment Interaction States
            const [interactionMode, setInteractionMode] = useState('idle'); // 'idle', 'select-region', 'select-regime-a', 'select-regime-b', 'confirm-move'
            const [targetRegion, setTargetRegion] = useState(null);
            const [moveRegimeA, setMoveRegimeA] = useState(null);
            const [moveRegimeB, setMoveRegimeB] = useState(null);
            const [scoreComparison, setScoreComparison] = useState(null); // { old: 0, new: 0 }



            // [New] Quick Score Calculation (Worker)
            const calculateQuickScores = async (gridData, orderData, seqsData) => {
                if (!gridData || !orderData) return;
                if (!workerRef.current) return;

                const safeGrid = prepareGrid(gridData, orderData);

                workerRef.current.postMessage({
                    type: 'QUICK_SCORE',
                    payload: {
                        grid: safeGrid,
                        colOrder: orderData,
                        masterSeqs: seqsData
                    }
                });
            };

            const parseContent = async (content, isJSON, preloadedColOrder = null, preloadedMasterSeqs = null) => {
                if (isJSON) {
                    try {
                        const json = JSON.parse(content);
                        if (json.colOrder) { setColOrder(json.colOrder); addLog("Â∑≤ÊÅ¢Â§çÂàóÈ°∫Â∫èÊ®°ÂÖ∑„ÄÇ"); }
                        if (json.masterSeqs) { setMasterSeqs(json.masterSeqs); addLog("Â∑≤ÊÅ¢Â§ç‰∏ªÂ∫èÂàóË°®Ê®°ÂÖ∑„ÄÇ"); }

                        // [New] Calculate Initial Scores immediately
                        if (data && json.colOrder) {
                            await calculateQuickScores(data.grid, json.colOrder, json.masterSeqs);
                        }

                        return json; // ËøîÂõû‰æõÈìæÂºèË∞ÉÁî®
                    } catch (err) { alert("JSON Error"); }
                } else {
                    setDataHash(simpleHash(content)); // [New] ËÆ°ÁÆóÊï∞ÊçÆ Hash
                    const lines = content.split(/\r?\n/).filter(l => l.trim());
                    const headers = lines[0].toLowerCase().split(',');
                    const findCol = (keys) => headers.findIndex(h => keys.some(k => h.includes(k)));
                    const idx = {
                        geoCode: findCol(['geo_code', 'region_code']),
                        geoName: findCol(['geo_name', 'region_name']),
                        start: findCol(['start']),
                        end: findCol(['end']),
                        regimeName: findCol(['regime_name', 'polity_name']),
                        regimeCode: findCol(['regime_code', 'polity_code'])
                    };
                    if (idx.geoName === -1) idx.geoName = idx.geoCode;
                    if (idx.regimeName === -1) idx.regimeName = idx.regimeCode;
                    if (idx.geoCode === -1 || idx.start === -1) { alert("CSV Error: Missing columns"); return; }

                    const regions = new Set();
                    const grid = {};
                    const regionNames = {};

                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                        if (row.length < 4) continue;
                        const geoCode = row[idx.geoCode];
                        const geoName = row[idx.geoName] || geoCode;
                        const start = parseInt(row[idx.start]);
                        let end = row[idx.end];
                        end = (end === '' || end.toLowerCase().includes('present')) ? CONFIG.MAX_YEAR : parseInt(end);
                        const regimeName = row[idx.regimeName];
                        const regimeCode = row[idx.regimeCode] || regimeName; // Ëé∑Âèñ Code

                        if (!geoCode || isNaN(start)) continue;
                        regions.add(geoCode);
                        regionNames[geoCode] = geoName;
                        // [New] Â≠òÂÇ®Êò†Â∞Ñ
                        if (!regionNames._codes) regionNames._codes = {};
                        regionNames._codes[regimeName] = regimeCode;

                        if (!grid[geoCode]) grid[geoCode] = {};
                        let loopEnd = (start === end) ? start : end - 1;
                        for (let y = start; y <= loopEnd; y++) {
                            if (y >= CONFIG.MIN_YEAR && y <= CONFIG.MAX_YEAR) {
                                if (!grid[geoCode][y]) grid[geoCode][y] = new Set();
                                // [Fix] ID Á≠ñÁï•ÔºöName + Code (Á°Æ‰øùË∑®Êó∂Èó¥ÊÆµÁöÑÊîøÊùÉÂêå‰∏ÄÊÄß)
                                grid[geoCode][y].add(regimeName + "|" + regimeCode);
                            }
                        }
                    }

                    const regionList = Array.from(regions).sort();
                    // ËøôÈáåÂêçÂ≠óÂ§çÁî® regionNames ÂØπË±°Â≠ò code mapÔºåÁ®çÂæÆÊúâÁÇπÊâÄË∞ìÔºå‰ΩÜÂèØ‰ª•Áî® ._codes ËÆøÈóÆ
                    setData({ regions: regionList, grid, names: regionNames, codes: regionNames._codes });

                    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ºòÂÖà‰ΩøÁî®‰º†ÂÖ•ÁöÑÈ¢ÑÂä†ËΩΩÈ°∫Â∫èÔºåÂê¶ÂàôÊâçÁî® State
                    const currentOrder = preloadedColOrder || colOrder;
                    // [New] ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ºòÂÖà‰ΩøÁî®‰º†ÂÖ•ÁöÑ‰∏ªÂ∫èÊ®°ÂÖ∑ÔºåÂê¶ÂàôÊâçÁî® State
                    const currentMasterSeqs = preloadedMasterSeqs || masterSeqs;

                    const newRegionSet = new Set(regionList);
                    const oldRegionSet = new Set(currentOrder);

                    // Ê†°È™åÈÄªËæëÔºöÂè™ÊúâÂΩì‰∏§‰∏™ÈõÜÂêàÂÖÉÁ¥†ÂÆåÂÖ®‰∏ÄËá¥Êó∂ÔºåÊâç‰øùÁïôÂ∏ÉÂ±Ä
                    const isSameRegions = currentOrder.length > 0 &&
                        newRegionSet.size === oldRegionSet.size &&
                        [...newRegionSet].every(x => oldRegionSet.has(x));

                    if (isSameRegions) {
                        try {
                            addLog("Ê£ÄÊµãÂà∞Âú∞Âå∫‰∏ÄËá¥Ôºå‰øùÁïôÁé∞ÊúâÂàóÈ°∫Â∫èÊ®°ÂÖ∑„ÄÇ");
                            // Êó¢ÁÑ∂‰∏ÄËá¥ÔºåÂ∞±Âº∫Âà∂Â∫îÁî®Ëøô‰∏™È°∫Â∫è
                            if (preloadedColOrder) setColOrder(preloadedColOrder);

                            if (currentMasterSeqs) {
                                addLog("Â∞ùËØïÂ∫îÁî®Áé∞Êúâ‰∏ªÂ∫èÂàóË°®Âà∞Êñ∞Êï∞ÊçÆ...");
                                // [Migrated] Áõ¥Êé•Êõ¥Êñ∞Áä∂ÊÄÅÔºåÂàÜÊï∞ÁªÑËÆ°ÁÆó‰∫§Áî± Worker (calculateQuickScores)
                                setMasterSeqs(currentMasterSeqs);
                                // Fix: Pass explicit data because state is not yet updated
                                const newLayout = generateCellLayout(currentMasterSeqs, { regions: regionList, grid });
                                setCellLayout(newLayout);
                                addLog(`Â∏ÉÂ±ÄÂä†ËΩΩÂÆåÊØï (ÂàÜÊï∞Â∞ÜÂú®ÂêéÂè∞ËÆ°ÁÆó)`);
                            } else {
                                // Default Init
                                const initLayout = {};
                                currentOrder.forEach(id => {
                                    initLayout[id] = {};
                                    for (let y = CONFIG.MIN_YEAR; y <= CONFIG.MAX_YEAR; y++) {
                                        const s = grid[id][y];
                                        initLayout[id][y] = s ? Array.from(s).sort() : [];
                                    }
                                });
                                setCellLayout(initLayout);
                            }
                        } catch (e) {
                            addLog(`[Error] Â∫îÁî®Â∏ÉÂ±ÄÂ§±Ë¥•: ${e.message}`);
                            console.error(e);
                            // Fallback to reset
                            setColOrder(regionList);
                            setMasterSeqs({});
                            setCellLayout({});
                        }
                    } else {
                        addLog(`Âú∞Âå∫Ê®°ÂÖ∑‰∏çÂåπÈÖç (Âéü:${oldRegionSet.size}, Êñ∞:${newRegionSet.size})ÔºåÈáçÁΩÆÂ∏ÉÂ±Ä„ÄÇ`);
                        setColOrder(regionList);
                        setMasterSeqs({});
                        setCellLayout({});
                    }
                    const finalOrder = isSameRegions ? (preloadedColOrder || currentOrder) : regionList;
                    const finalSeqs = isSameRegions ? currentMasterSeqs : null;

                    // [New] Calc Scores
                    calculateQuickScores(grid, finalOrder, finalSeqs);

                    setStatus('ready');
                }
            };

            const addLog = (msg) => setLogs(prev => [...prev.slice(-499), `> ${msg}`]);
            useEffect(() => { if (logEndRef.current) logEndRef.current.scrollIntoView({ behavior: "smooth" }); }, [logs]);

            const runColumnOptimizer = () => {
                if (!data || status !== 'ready') return;
                stopRef.current = false;
                setStatus('optimizing');
                addLog("=== Ê≠•È™§ 1: Áã¨Á´ãÂàóÊéíÂ∫è (TSP Worker) ===");

                if (workerRef.current) {
                    workerRef.current.postMessage({
                        type: 'START_TSP_ONLY',
                        payload: {
                            data: prepareWorkerData(data),
                            colOrder: colOrder,
                            iterations: { tsp: 50000000 }
                        }
                    });
                }
            };

            const runCellOptimizer = () => {
                if (!data || status !== 'ready') return;
                stopRef.current = false;
                setStatus('optimizing');
                addLog("=== Ê≠•È™§ 2: Áã¨Á´ãÂ∏ÉÂ±Ä‰ºòÂåñ (Layout Worker) ===");
                addLog(`[Debug] masterSeqs Áä∂ÊÄÅ: ${masterSeqs ? Object.keys(masterSeqs).length + 'Âàó' : 'NULL'}`);

                if (workerRef.current) {
                    workerRef.current.postMessage({
                        type: 'START_LAY_ONLY',
                        payload: {
                            data: prepareWorkerData(data),
                            colOrder: colOrder,
                            masterSeqs: masterSeqs,
                            iterations: { lay: 500000 }
                        }
                    });
                }
            };

            const runDeepJointOptimization = () => {
                if (!data || status !== 'ready') return;
                // stopRef.current is strictly for UI toggle state now, worker has internal flag
                stopRef.current = false;
                setStatus('optimizing');
                addLog("=== üöÄ ÂêØÂä®Ê∑±Â∫¶ËÅîÂêà‰ºòÂåñ (WorkerÁâà) ===");

                if (workerRef.current) {
                    workerRef.current.postMessage({
                        type: 'START_DEEP_OPT',
                        payload: {
                            data: prepareWorkerData(data),
                            colOrder: colOrder,
                            masterSeqs: masterSeqs, // Pass current state as seed
                            tspBestScore: tspBestScore,
                            iterations: {
                                tsp: 50000000, // 50M
                                lay: 500000   // 500k
                            }
                        }
                    });
                } else {
                    addLog("‚ùå Worker Êú™ÂàùÂßãÂåñ");
                    setStatus('ready');
                }
            };

            // ... Inside Return JSX for Logs ...
            // <div className="h-40 overflow-y-auto ...">
            //    {logs.map((l, i) => {
            //        const isHighlight = l.includes("Breakthrough") || l.includes("New Best") || l.includes("Final Score");
            //        return (
            //          <div key={i} style={{ 
            //              color: isHighlight ? '#4ade80' : '#9ca3af',
            //              fontWeight: isHighlight ? 'bold' : 'normal'
            //          }}>{l}</div>
            //        );
            //    })}
            // </div>



            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => parseContent(evt.target.result, file.name.endsWith('.json'));
                reader.readAsText(file);
                e.target.value = '';
            };

            // [New] Âä†ËΩΩËøúÁ®ã CSV
            const loadRemoteCSV = async (url = null, preloadedColOrder = null, preloadedMasterSeqs = null) => {
                const GOOGLE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMSHMYH-_pI-2v9bqP-1Balz19zzjAW9QyykU5D1GsfnGVV4Xt-OwPjOlFKPwQL2rQ9EVGCgl7ikCs/pub?gid=0&single=true&output=csv";
                const LOCAL_CSV = "history_data.csv";

                let targetUrl = url || GOOGLE_CSV;
                addLog(`Ê≠£Âú®Â∞ùËØïÂä†ËΩΩÊï∞ÊçÆ: ${targetUrl}...`);

                const tryFetch = async (u) => {
                    // Ê∑ªÂä†Êó∂Èó¥Êà≥Èò≤ÁºìÂ≠ò
                    const fetchUrl = u + (u.includes('?') ? '&' : '?') + 't=' + Date.now();
                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.text();
                };

                try {
                    const text = await tryFetch(targetUrl);
                    addLog("Êï∞ÊçÆ‰∏ãËΩΩÂÆåÊàêÔºåÂºÄÂßãËß£Êûê...");
                    parseContent(text, false, preloadedColOrder, preloadedMasterSeqs);
                } catch (e) {
                    addLog(`Âä†ËΩΩÂ§±Ë¥• (${targetUrl}): ${e.message}`);
                    if (!url && targetUrl === GOOGLE_CSV) {
                        addLog(`Ê≠£Âú®Â∞ùËØïÈôçÁ∫ßÂä†ËΩΩÊú¨Âú∞Êñá‰ª∂: ${LOCAL_CSV}...`);
                        try {
                            const localText = await tryFetch(LOCAL_CSV);
                            addLog("Êú¨Âú∞Êï∞ÊçÆ‰∏ãËΩΩÂÆåÊàêÔºåÂºÄÂßãËß£Êûê...");
                            parseContent(localText, false, preloadedColOrder, preloadedMasterSeqs);
                        } catch (e2) {
                            addLog(`Êú¨Âú∞Âä†ËΩΩ‰πüÂ§±Ë¥•‰∫Ü: ${e2.message}`);
                            alert(`Êó†Ê≥ïÂä†ËΩΩ‰∫ëÁ´ØÊàñÊú¨Âú∞Êï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÊâãÂä®‰∏ä‰º†„ÄÇ`);
                        }
                    } else {
                        alert(`Êó†Ê≥ïÂä†ËΩΩ ${targetUrl}: ${e.message}`);
                    }
                }
            };

            // [New] Ëá™Âä®ËøêË°åÈÄªËæë
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const csvUrl = params.get('csv');
                const autorun = params.get('autorun');

                let loadedLayout = null;

                // 1. ÊÄªÊòØÂ∞ùËØïÂä†ËΩΩ layout.json ‰ª•ÊÅ¢Â§çÊ®°ÂÖ∑ (Column Order)
                fetch('layout.json?t=' + Date.now())
                    .then(res => {
                        if (res.ok) return res.text();
                        throw new Error('No layout.json');
                    })
                    .then(async text => {
                        addLog("ÂèëÁé∞ layout.jsonÔºåÊ≠£Âú®ÊÅ¢Â§çÂàóÈ°∫Â∫èÊ®°ÂÖ∑...");
                        // Ëß£ÊûêÂπ∂‰øùÂ≠òÔºå‰ΩÜ‰∏ç‰æùËµñ State
                        loadedLayout = await parseContent(text, true);
                    })
                    .catch(() => addLog("Êú™ÊâæÂà∞ layout.json ÊàñÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÈªòËÆ§ÊàñÊñ∞ÁîüÊàêÁöÑÂ∏ÉÂ±Ä„ÄÇ"))
                    .finally(() => {
                        const preloadedOrder = loadedLayout ? loadedLayout.colOrder : null;
                        const preloadedSeqs = loadedLayout ? loadedLayout.masterSeqs : null;

                        // 2. Âä†ËΩΩÊï∞ÊçÆ (CSV)
                        if (csvUrl) {
                            loadRemoteCSV(csvUrl, preloadedOrder, preloadedSeqs);
                        } else if (autorun === 'true') {
                            // ‰∏ç‰º†ÂèÇÔºå‰ΩøÁî® loadRemoteCSV ÂÜÖÈÉ®ÂÆö‰πâÁöÑÈªòËÆ§ÈÄªËæë (Google -> history_data.csv)
                            loadRemoteCSV(null, preloadedOrder, preloadedSeqs);
                        } else {
                            // [Fix] Default behavior: Load remote CSV anyway
                            loadRemoteCSV(null, preloadedOrder, preloadedSeqs);
                        }
                    });
            }, []);

            const handleStop = () => {
                stopRef.current = true;
                if (workerRef.current) {
                    addLog("Âº∫Âà∂ÂÅúÊ≠¢‰ºòÂåñ„ÄÇÂ∑≤‰øùÂ≠òÊúÄÊñ∞ËøõÂ∫¶„ÄÇ");
                    initWorker(); // Force terminate and restart
                }
                setStatus('ready');
            };




            const handleFlip = () => {
                const newFlipped = !isFlipped;
                setIsFlipped(newFlipped);

                // 1. ÁøªËΩ¨ÂàóÈ°∫Â∫è
                setColOrder(prev => [...prev].reverse());

                // 2. ÁøªËΩ¨ÂçïÂÖÉÊ†ºÂÜÖÈ°∫Â∫è (Master Seqs need to be reversed too if we want true flip, but usually visuals are enough. Actually, LAY doesn't care about internal order for flip, but rendering does.)
                // For visual consistency, let's reverse the masterSeqs effectively by reversing the layout arrays
                setCellLayout(prev => {
                    const next = {};
                    Object.keys(prev).forEach(id => {
                        next[id] = {};
                        Object.keys(prev[id]).forEach(y => {
                            next[id][y] = [...prev[id][y]].reverse();
                        });
                    });
                    return next;
                });

                addLog(`Â∏ÉÂ±ÄÂ∑≤${newFlipped ? 'ÁøªËΩ¨' : 'ËøòÂéü'} (North/South)`);
            };

            // === Column Drag & Drop Handlers ===
            // === Interactive Sequence Adjustment ===
            const startManualAdjustment = () => {
                setInteractionMode('select-region');
                addLog("[Manual] ËØ∑ÁÇπÂáªÈÄâÊã©Ë¶Å‰øÆÊîπÁöÑÂú∞Âå∫ÔºàÂàóÊ†áÈ¢òÔºâ");
            };

            const handleHeaderClick = (index) => {
                if (interactionMode !== 'select-region') return;
                const colId = colOrder[index];
                setTargetRegion(colId);
                setInteractionMode('select-regime-a');
                addLog(`[Manual] Â∑≤ÈÄâÊã©Âú∞Âå∫: ${data.names[colId]}„ÄÇËØ∑ÁÇπÂáªË¶ÅÁßªÂä®ÁöÑÊîøÊùÉ (A)`);
            };

            const handleRegimeClick = (regime, colId) => {
                if (colId !== targetRegion && interactionMode.startsWith('select-regime')) {
                    addLog(`[Manual] ÈîôËØØÔºöËØ∑ÈÄâÊã©ÂΩìÂâçÂú∞Âå∫ (${data.names[targetRegion]}) ÂÜÖÁöÑÊîøÊùÉ`);
                    return;
                }

                if (interactionMode === 'select-regime-a') {
                    setMoveRegimeA(regime);
                    setInteractionMode('select-regime-b');
                    addLog(`[Manual] Â∑≤ÈÄâÊã©ÁßªÂä®ÂØπË±°: ${regime.split('|')[0]}„ÄÇËØ∑ÁÇπÂáªÁõÆÊ†á‰ΩçÁΩÆÁöÑÂèÇÁÖßÊîøÊùÉ (B)ÔºåA Â∞ÜË¢´ÊèíÂÖ•Âà∞ B ‰πãÂâç„ÄÇ`);
                } else if (interactionMode === 'select-regime-b') {
                    // Prevent same regime
                    if (regime === moveRegimeA) return;

                    setMoveRegimeB(regime);
                    setInteractionMode('confirm-move');

                    try {
                        // Pre-calculate score
                        const rA = moveRegimeA;
                        const rB = regime;

                        // [Fix] Must initialize weights via init()
                        const sorter = new GlobalSequenceOptimizer(colOrder, data.grid, () => { });
                        sorter.init(JSON.parse(JSON.stringify(masterSeqs)));

                        const oldScore = sorter.calculateGlobalScore(sorter.masterSeqs);

                        // Simulate Move: Insert A before B
                        const seq = sorter.masterSeqs[targetRegion];
                        // Helper
                        const findIndex = (s, target) => {
                            let idx = s.indexOf(target);
                            if (idx !== -1) return idx;
                            const targetBase = target.split('|')[0];
                            return s.findIndex(item => item.split('|')[0] === targetBase);
                        };

                        const idxA = findIndex(seq, rA);
                        if (idxA === -1) {
                            // A ‰∏çÂ≠òÂú®Â∫èÂàó‰∏≠ÔºåÂèØËÉΩÊòØÂêçÁß∞‰∏çÂåπÈÖçÔºåÂ∞ùËØï‰∏•Ê†ºÊ®°ÂºèÂ§±Ë¥•ÂêéÁöÑÈôçÁ∫ß
                            console.warn(`[Precheck] A not found: ${rA}`);
                            return;
                        }

                        // Remove A first
                        seq.splice(idxA, 1);

                        let idxB = findIndex(seq, rB);
                        if (idxB === -1) {
                            console.warn(`[Precheck] B not found: ${rB}`);
                            return;
                        }

                        // Insert A at B
                        seq.splice(idxB, 0, rA);

                        sorter.masterSeqs[targetRegion] = seq;
                        const newScore = sorter.calculateGlobalScore(sorter.masterSeqs);

                        setScoreComparison({ old: Math.floor(oldScore), new: Math.floor(newScore) });
                        addLog(`[Manual] È¢ÑËÆ°ÁÆóÂÆåÊàê„ÄÇÂéüÂàÜ: ${Math.floor(oldScore)} -> Êñ∞ÂàÜ: ${Math.floor(newScore)}`);
                    } catch (e) {
                        console.error(e);
                        addLog(`[Error] È¢ÑËÆ°ÁÆóÂ§±Ë¥•: ${e.message}`);
                        setInteractionMode('select-regime-b'); // Revert
                    }
                }
            };

            const confirmMove = () => {
                try {
                    const sorter = new GlobalSequenceOptimizer(colOrder, data.grid, () => { });
                    sorter.init(JSON.parse(JSON.stringify(masterSeqs)));

                    const seq = sorter.masterSeqs[targetRegion];
                    const rA = moveRegimeA;
                    const rB = moveRegimeB;

                    // Helper to find index robustly
                    const findIndex = (s, target) => {
                        let idx = s.indexOf(target);
                        if (idx !== -1) return idx;
                        // Try fuzzy match (ignore pipe suffix/prefix mismatch)
                        const targetBase = target.split('|')[0];
                        return s.findIndex(item => item.split('|')[0] === targetBase);
                    };

                    const idxA = findIndex(seq, rA);
                    if (idxA === -1) throw new Error(`Êó†Ê≥ïÂú®ÂΩìÂâçÂ∫èÂàó‰∏≠ÊâæÂà∞ÊîøÊùÉ: ${rA}`);

                    // Remove A first
                    seq.splice(idxA, 1);

                    const idxB = findIndex(seq, rB);
                    if (idxB === -1) throw new Error(`Êó†Ê≥ïÂú®ÂΩìÂâçÂ∫èÂàó‰∏≠ÊâæÂà∞ÁõÆÊ†áÊîøÊùÉ: ${rB}`);

                    // Insert A at B
                    seq.splice(idxB, 0, rA);

                    // Update State
                    setMasterSeqs(sorter.masterSeqs);
                    const newLayout = sorter.generateLayout(sorter.masterSeqs);
                    setCellLayout(newLayout);
                    setLayoutScore(scoreComparison?.new || sorter.calculateGlobalScore(sorter.masterSeqs));

                    addLog(`[Manual] ‰øÆÊîπÂ∑≤Â∫îÁî®„ÄÇ`);
                    resetManualMode();
                } catch (e) {
                    console.error(e);
                    addLog(`[Error] Â∫îÁî®‰øÆÊîπÂ§±Ë¥•: ${e.message}`);
                }
            };

            const cancelMove = () => {
                addLog(`[Manual] Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ`);
                resetManualMode();
            };

            const resetManualMode = () => {
                setInteractionMode('idle');
                setTargetRegion(null);
                setMoveRegimeA(null);
                setMoveRegimeB(null);
                setScoreComparison(null);
            };

            // === Column Drag (Keep this for column reordering only) ===
            const handleDragStart = (e, index) => {
                setDraggedCol(index);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("type", "column");
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedCol === null || draggedCol === index) return;
            };

            const handleDrop = (e, targetIndex) => {
                e.preventDefault();
                if (e.dataTransfer.getData("type") !== "column") return;
                if (draggedCol === null || draggedCol === targetIndex) return;
                const newOrder = [...colOrder];
                const [removed] = newOrder.splice(draggedCol, 1);
                newOrder.splice(targetIndex, 0, removed);
                setColOrder(newOrder);
                setDraggedCol(null);
                addLog(`ÂàóÂ∑≤ÊâãÂä®ÈáçÊéí: ${data.names[removed] || removed} -> Position ${targetIndex}`);
            };

            const totalYears = CONFIG.MAX_YEAR - CONFIG.MIN_YEAR + 1;
            const totalH = totalYears * CONFIG.ROW_HEIGHT;

            // YËΩ¥ËôöÊãüÂåñÔºöÂè™Ê∏≤ÊüìÂèØËßÅÂπ¥‰ªΩ (Overscan 10)
            const OVERSCAN = 10;
            const startIdx = Math.max(0, Math.floor(scrollTop / CONFIG.ROW_HEIGHT) - OVERSCAN);
            const endIdx = Math.min(totalYears, Math.floor(scrollTop / CONFIG.ROW_HEIGHT) + Math.ceil(viewportH / CONFIG.ROW_HEIGHT) + OVERSCAN);
            const visibleYears = [];
            for (let i = startIdx; i < endIdx; i++) visibleYears.push(CONFIG.MIN_YEAR + i);

            // XËΩ¥ËôöÊãüÂåñÔºöÂè™Ê∏≤ÊüìÂèØËßÅÂàó (Overscan 5)
            const YEAR_COL_WIDTH = 60; // Âπ¥‰ªΩÂàóÂõ∫ÂÆöÂÆΩÂ∫¶
            const colOverscan = 5;
            const colStartIdx = Math.max(0, Math.floor((scrollLeft - YEAR_COL_WIDTH) / CONFIG.COL_WIDTH) - colOverscan);
            const colEndIdx = Math.min(colOrder.length, Math.floor((scrollLeft - YEAR_COL_WIDTH) / CONFIG.COL_WIDTH) + Math.ceil(viewportW / CONFIG.COL_WIDTH) + colOverscan);
            const visibleColIndices = [];
            for (let i = colStartIdx; i < colEndIdx; i++) visibleColIndices.push(i);

            const exportJSON = () => {
                // [v10] ÁîüÊàêÁâàÊú¨Âè∑ YYYYMMDDHHmmss
                const now = new Date();
                const version = now.getFullYear().toString() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0') +
                    String(now.getSeconds()).padStart(2, '0');

                const out = {
                    version,  // ÁâàÊú¨Âè∑ÔºåÁî®‰∫éÂÆ¢Êà∑Á´ØÁºìÂ≠òÁ≠ñÁï•
                    colOrder,
                    layout: cellLayout,
                    names: data.names,
                    masterSeqs: masterSeqs,
                    tspScore: tspBestScore
                };
                console.log(`[Export] layout.json with version: ${version}`);
                const blob = new Blob([JSON.stringify(out)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'layout.json'; a.click();
            };
            // [New] Ê†πÊçÆËßÜËßí‰ΩøÁî®‰∏çÂêå ID
            const saveToDB = () => {
                if (!data || !cellLayout) return;

                const perspective = data.perspective || "default";
                // [Fix] Panorama reads 'current' by default. Match that behavior.
                const layoutId = perspective === "default" ? "current" : `layout_${perspective}`;

                // [v10] ÁîüÊàêÁâàÊú¨Âè∑Áî®‰∫é DB Â≠òÂÇ®
                const now = new Date();
                const version = now.getFullYear().toString() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0') +
                    String(now.getSeconds()).padStart(2, '0');

                // [v10] Payload now includes version
                const payload = {
                    version,  // ÁâàÊú¨Âè∑
                    names: data.names,
                    codes: data.codes,
                    masterSeqs: masterSeqs,
                    layout: cellLayout,
                    colOrder: colOrder,
                    grid: data.grid,
                    perspective: perspective,
                    timestamp: Date.now()
                };

                // [Fix] Explicitly use version 5 to trigger schema upgrade for users who possess legacy DB
                const request = indexedDB.open("EastAsiaHistoryDB", 5);

                request.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("layouts")) {
                        db.createObjectStore("layouts", { keyPath: "id" });
                    }
                };

                request.onsuccess = function (event) {
                    const db = event.target.result;
                    const transaction = db.transaction(["layouts"], "readwrite");
                    const store = transaction.objectStore("layouts");

                    // [CRITICAL] Panorama expects DB entry to be { id: "current", data: payload }
                    // Wraps the payload in a 'data' property.

                    // 1. Save strictly as 'current' (This is what Panorama reads)
                    const entryCurrent = { id: 'current', data: payload };
                    store.put(entryCurrent);

                    // 2. Save as specific ID (if different)
                    if (layoutId !== 'current') {
                        const entrySpecific = { id: layoutId, data: payload };
                        store.put(entrySpecific);
                    }

                    transaction.oncomplete = function () {
                        // [Debug] Verify persistence
                        const verifyReq = indexedDB.open("EastAsiaHistoryDB");
                        verifyReq.onsuccess = (ev) => {
                            const db2 = ev.target.result;
                            const tx2 = db2.transaction(["layouts"], "readonly");
                            const st2 = tx2.objectStore("layouts");
                            const get2 = st2.get("current");
                            get2.onsuccess = () => {
                                if (get2.result && get2.result.data && get2.result.data.layout) {
                                    addLog(`[System] ‚úÖ ÊàêÂäüÂÜôÂÖ• DB Âπ∂ÈÄöËøáËá™Ê£Ä (ID: current)`);
                                    if (confirm(`Â∏ÉÂ±ÄÂ∑≤‰øùÂ≠ò‰∏∫ [${layoutId}]ÔºÅ\nÊòØÂê¶Ë∑≥ËΩ¨Âà∞ÂÖ®ÊôØÂõæÊü•ÁúãÔºü`)) {
                                        // [Fix] Ë∑≥ËΩ¨Âà∞ index.html ËÄåÈùû panorama.htmlÔºåÂõ†‰∏∫ÂçïÁã¨ÁöÑ panorama.html Êó†Ê≥ïÊ≠£Â∏∏Â∑•‰Ωú
                                        window.location.href = "index.html?view=panorama&t=" + Date.now();
                                    }
                                } else {
                                    alert("‚ùå ‰∏•ÈáçÈîôËØØÔºöÂÜôÂÖ•ÂêéÁöÑÊï∞ÊçÆÁªìÊûÑ‰∏çÁ¨¶ÂêàÈ¢ÑÊúüÔºÅ");
                                    console.error("Verification failed. Result:", get2.result);
                                }
                            };
                        };
                    };

                    transaction.onerror = function (e) {
                        addLog(`[Error] DB ‰∫ãÂä°Â§±Ë¥•: ${e.target.error}`);
                        console.error("Transaction Error", e);
                    }
                };

                request.onerror = function (event) {
                    console.error("IndexedDB Error", event);
                    alert("Êó†Ê≥ïÊâìÂºÄ IndexedDB");
                };
            };

            const runFlip = () => { handleFlip(); }; // Wrap handleFlip

            // Á∫Ø JS Ê∏≤Êüì
            return h('div', { className: "h-full flex flex-col bg-slate-900 text-slate-200" },
                // 1. Top Panel
                h('div', { className: "glass-panel z-50 px-4 py-3 flex items-center justify-between shadow-xl relative backdrop-blur-md bg-opacity-90 border-b border-slate-700/50" },
                    // Left
                    h('div', { className: "flex items-center gap-4" },
                        h('div', { className: "flex flex-col leading-tight" },
                            h('span', { className: "font-bold text-lg text-slate-100 tracking-tight" }, "Layout Optimizer"),
                            h('span', { className: "text-[10px] text-purple-400 font-mono" }, "v11.0 ULTRA (No-Babel)")
                        ),
                        h('div', { className: "h-8 w-px bg-slate-700/50 mx-2" }),
                        h('div', { className: "flex gap-2" },
                            h('label', { className: "btn bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600/50 cursor-pointer" },
                                h('span', { className: "opacity-80" }, "üìÅ ÂØºÂÖ•"),
                                h('input', { type: "file", accept: ".csv,.json", onChange: handleFile, className: "hidden", ref: fileInputRef })
                            ),
                            h('button', { onClick: () => loadRemoteCSV(), className: "btn bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600/50", title: "Google Sheet / Local" }, "‚òÅÔ∏è ‰∫ëÁ´ØÊï∞ÊçÆ")
                        )
                    ),
                    // Center
                    h('div', { className: "absolute left-1/2 -translate-x-1/2 flex gap-2" },
                        (status !== 'optimizing') ? h(Fragment, null,
                            h('button', { onClick: runColumnOptimizer, className: "btn bg-slate-700 hover:bg-slate-600 text-slate-200 shadow-lg border border-slate-600/50", disabled: !data }, "ÂàóÂ∫è‰ºòÂåñ"),
                            h('button', { onClick: runCellOptimizer, className: "btn bg-slate-700 hover:bg-slate-600 text-slate-200 shadow-lg border border-slate-600/50", disabled: !data }, "ÂàóÂÜÖ‰ºòÂåñ"),
                            h('div', { className: "w-px h-8 bg-slate-700/50 mx-1" }),
                            h('button', { onClick: runDeepJointOptimization, className: "btn bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white shadow-lg shadow-emerald-900/40 border-0 font-bold px-6", disabled: !data, title: "‰∏ÄÈîÆËøêË°å TSP ÂàóÊéíÂ∫è + Master Seq Â∏ÉÂ±Ä‰ºòÂåñ" }, "üöÄ ËÅîÂêà‰ºòÂåñ")
                        ) : h('div', { className: "flex gap-2 items-center bg-slate-800 rounded px-3 border border-slate-700" },
                            h('span', { className: "text-xs font-mono text-blue-300 animate-pulse" }, 'OPTIMIZING...'),
                            h('button', { onClick: handleStop, className: "ml-2 text-xs text-red-400 hover:text-red-300" }, "STOP")
                        )
                    ),
                    // Right
                    h('div', { className: "flex items-center gap-4" },
                        h('div', { className: "flex flex-col items-end mr-2 font-mono text-[10px] text-slate-400 cursor-help", title: "Score Info" },
                            h('div', null, "TSP: ", h('span', { className: "text-emerald-400" }, Math.round(tspBestScore).toLocaleString())),
                            h('div', null, "LAY: ", h('span', { className: "text-blue-400" }, layoutScore !== 0 ? Math.round(layoutScore).toLocaleString() : '--'))
                        ),
                        h('div', { className: "h-8 w-px bg-slate-700/50" }),
                        h('div', { className: "flex gap-2" },
                            h('button', {
                                onClick: interactionMode === 'idle' ? startManualAdjustment : resetManualMode,
                                className: `btn ${interactionMode !== 'idle' ? 'bg-amber-600 hover:bg-amber-500' : 'bg-indigo-600 hover:bg-indigo-500'} text-white border-0`,
                                disabled: !data,
                                title: "ÊâãÂä®ÂæÆË∞É"
                            }, interactionMode !== 'idle' ? '‚ùå ÂèñÊ∂à' : 'üõ†Ô∏è ‰øÆÊîπÂ∫èÂàó'),
                            h('button', { onClick: saveToDB, className: "btn bg-teal-600 hover:bg-teal-500 text-white shadow-lg shadow-teal-900/20 border-0", disabled: !data, title: "‰øùÂ≠òÂà∞ DB" }, "üíæ ÂÜôÂÖ• DB"),
                            h('button', { onClick: exportJSON, className: "btn bg-slate-700 hover:bg-slate-600 text-slate-200 border border-slate-600", disabled: !data, title: "ÂØºÂá∫ JSON" }, "üì§ ÂØºÂá∫"),
                            h('a', { href: "index.html", className: "btn bg-slate-800 hover:bg-slate-700 text-slate-400 border border-slate-600/50", title: "ËøîÂõûÈ¶ñÈ°µ" }, "üè†")
                        )
                    )
                ),

                // 2. Interaction Bar
                interactionMode !== 'idle' && h('div', { className: "h-10 bg-amber-900 border-b border-amber-600 flex items-center justify-between px-4 text-xs font-medium text-amber-100 animate-fade-in z-20 shadow-md" },
                    h('div', { className: "flex items-center gap-2" },
                        h('span', { className: "mr-2 text-amber-400 font-bold" }, "üîß Â∫èÂàóÁºñËæë:"),
                        interactionMode === 'select-region' && "ËØ∑ÁÇπÂáªÈÄâÊã©Ë¶Å‰øÆÊîπÁöÑÂú∞Âå∫ÔºàÂàóÊ†áÈ¢òÔºâ",
                        interactionMode === 'select-regime-a' && h('span', null, "Â∑≤ÈÄâÂú∞Âå∫ ", h('span', { className: "text-white px-1 bg-amber-800 rounded" }, data.names[targetRegion]), "„ÄÇËØ∑ÁÇπÂáªË¶ÅÁßªÂä®ÁöÑÊîøÊùÉ (A)"),
                        interactionMode === 'select-regime-b' && h('span', null, "Â∑≤ÈÄâ ", h('span', { className: "text-white px-1 bg-amber-800 rounded" }, moveRegimeA.split('|')[0]), "„ÄÇËØ∑ÁÇπÂáªÁõÆÊ†áÈîöÁÇπÊîøÊùÉ (B)"),
                        interactionMode === 'confirm-move' && scoreComparison && h('span', { className: "flex items-center gap-2" },
                            h('span', null, "Â∞Ü ", h('strong', { className: "text-white" }, moveRegimeA.split('|')[0]), " ÁßªËá≥ ", h('strong', { className: "text-white" }, moveRegimeB.split('|')[0]), " ‰πãÂâç„ÄÇ"),
                            h('span', { className: "text-slate-400" }, "|"),
                            h('span', null, "ÂàÜÊï∞ÂèòÂåñ: ", scoreComparison.old.toLocaleString(), " ‚Üí ", h('span', { className: `${scoreComparison.new > scoreComparison.old ? 'text-emerald-400' : (scoreComparison.new < scoreComparison.old ? 'text-rose-400' : 'text-white')} font-bold` }, scoreComparison.new.toLocaleString()))
                        )
                    ),
                    interactionMode === 'confirm-move' ? h('div', { className: "flex gap-2" },
                        h('button', { onClick: cancelMove, className: "px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded text-xs border border-slate-500" }, "‚ùå ÂèñÊ∂à"),
                        h('button', { onClick: confirmMove, className: "px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold shadow-lg border border-emerald-400" }, "‚úÖ Á°ÆËÆ§‰øÆÊîπ")
                    ) : h('button', { onClick: resetManualMode, className: "text-amber-400/60 hover:text-amber-200 text-xs" }, "ÈÄÄÂá∫")
                ),
                // 3. Matrix Viewport
                h('div', { className: "flex-1 overflow-hidden relative flex flex-col pt-[1px]" },
                    data ? h('div', {
                        className: "matrix-viewport",
                        onScroll: (e) => {
                            const { scrollTop, scrollLeft } = e.target;
                            if (!ticking.current) {
                                window.requestAnimationFrame(() => {
                                    setScrollTop(scrollTop);
                                    setScrollLeft(scrollLeft);
                                    ticking.current = false;
                                });
                                ticking.current = true;
                            }
                        },
                        ref: (el) => {
                            if (el) {
                                gridRef.current = el;
                                if (el.clientHeight !== viewportH) setViewportH(el.clientHeight);
                                if (el.clientWidth !== viewportW) setViewportW(el.clientWidth);
                            }
                        }
                    },
                        h('div', { style: { height: totalH, width: 60 + colOrder.length * CONFIG.COL_WIDTH, position: 'relative' } },
                            // Header Row (XËΩ¥ËôöÊãüÂåñ)
                            h('div', { className: "header-row", style: { width: '100%', minWidth: 'max-content' } },
                                h('div', {
                                    className: "header-cell sticky left-0 z-[60] w-[60px] bg-slate-800 border-r border-slate-600 text-slate-400 cursor-pointer hover:bg-slate-700 hover:text-emerald-400 transition-colors flex justify-center items-center",
                                    onClick: handleFlip
                                }, "‚áÑ"),
                                // Â∑¶‰æßÂç†‰ΩçÁ¨¶Ôºà‰∏çÂèØËßÅÂàóÁöÑÁ©∫Èó¥Ôºâ
                                colStartIdx > 0 ? h('div', {
                                    key: 'left-spacer',
                                    style: { width: colStartIdx * CONFIG.COL_WIDTH, flexShrink: 0 }
                                }) : null,
                                // ÂèØËßÅÂàó
                                visibleColIndices.map(index => {
                                    const id = colOrder[index];
                                    const isSelected = targetRegion === id;
                                    const isModeSelectRegion = interactionMode === 'select-region';
                                    return h('div', {
                                        key: id,
                                        className: `header-cell ${draggedCol === index ? 'opacity-50 dashed-border' : ''} ${isSelected ? 'bg-amber-800/80 text-amber-100 ring-2 ring-amber-500 z-50' : ''} ${isModeSelectRegion ? 'cursor-pointer hover:bg-amber-900/50 ring-1 ring-amber-500/30' : 'cursor-move hover:bg-slate-700'} transition-all select-none`,
                                        style: { width: CONFIG.COL_WIDTH },
                                        title: data.names[id] || id,
                                        draggable: interactionMode === 'idle',
                                        onDragStart: (e) => handleDragStart(e, index),
                                        onDragOver: (e) => handleDragOver(e, index),
                                        onDrop: (e) => handleDrop(e, index),
                                        onClick: () => handleHeaderClick(index)
                                    }, data.names[id] || id);
                                }),
                                // Âè≥‰æßÂç†‰ΩçÁ¨¶
                                colEndIdx < colOrder.length ? h('div', {
                                    key: 'right-spacer',
                                    style: { width: (colOrder.length - colEndIdx) * CONFIG.COL_WIDTH, flexShrink: 0 }
                                }) : null
                            ),
                            // Data Rows (Y+XËΩ¥ÂèåÂêëËôöÊãüÂåñ)
                            visibleYears.map(year => h('div', { key: year, className: "data-row", style: { top: (year - CONFIG.MIN_YEAR) * CONFIG.ROW_HEIGHT + 36, height: CONFIG.ROW_HEIGHT } },
                                h('div', { className: "year-col-container flex items-center justify-center h-full" },
                                    h('div', { className: "font-mono text-[10px] text-slate-500" }, year)
                                ),
                                // Â∑¶‰æßÂç†‰ΩçÁ¨¶
                                colStartIdx > 0 ? h('div', {
                                    key: 'left-spacer',
                                    style: { width: colStartIdx * CONFIG.COL_WIDTH, flexShrink: 0 }
                                }) : null,
                                // ÂèØËßÅÂàó
                                visibleColIndices.map(index => {
                                    const id = colOrder[index];
                                    const regimes = cellLayout[id]?.[year] || [];
                                    return h('div', { key: id, className: "data-cell", style: { width: CONFIG.COL_WIDTH } },
                                        regimes.map(r => {
                                            const isSelectedA = moveRegimeA === r;
                                            const isSelectedB = moveRegimeB === r;
                                            const isInteractive = (interactionMode === 'select-regime-a' && targetRegion === id) || (interactionMode === 'select-regime-b' && targetRegion === id);
                                            return h('div', {
                                                key: r,
                                                className: `regime-block ${isSelectedA ? 'ring-2 ring-amber-400 z-10 scale-105' : ''} ${isSelectedB ? 'ring-2 ring-blue-400 z-10' : ''} ${isInteractive ? 'cursor-pointer hover:opacity-80' : ''}`,
                                                style: { backgroundColor: calcColor(r.split('|')[1] || data.codes[r.split('|')[0]] || r) },
                                                title: r,
                                                onClick: (e) => { e.stopPropagation(); handleRegimeClick(r, id); }
                                            }, r.split('|')[0]);
                                        })
                                    );
                                }),
                                // Âè≥‰æßÂç†‰ΩçÁ¨¶
                                colEndIdx < colOrder.length ? h('div', {
                                    key: 'right-spacer',
                                    style: { width: (colOrder.length - colEndIdx) * CONFIG.COL_WIDTH, flexShrink: 0 }
                                }) : null
                            ))
                        )
                    ) : h('div', { className: "flex-1 flex flex-col items-center justify-center text-slate-600 bg-slate-950" },
                        h('p', { className: "text-sm font-medium" }, "ËØ∑ÂØºÂÖ• CSV Êï∞ÊçÆÊñá‰ª∂ / JSON Ê®°ÂÖ∑")
                    )
                ),
                // 4. Log Panel
                h('div', { className: "h-32 bg-slate-950 border-t border-slate-800 flex flex-col font-mono text-[10px] shadow-inner-lg z-50" },
                    h('div', { className: "px-4 py-1 bg-slate-900 border-b border-slate-800 text-slate-500 flex justify-between items-center" },
                        h('div', { className: "flex items-center gap-3" },
                            h('span', null, "CONSOLE LOG"),
                            h('button', {
                                onClick: () => navigator.clipboard.writeText(logs.join('\n')),
                                className: "text-[9px] px-1.5 py-0.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-slate-400 hover:text-white transition-colors cursor-pointer",
                                title: "Copy full logs"
                            }, "COPY")
                        ),
                        h('span', { className: status === 'ranking' || status === 'layout' ? 'text-blue-400 animate-pulse' : 'text-emerald-500' }, status === 'idle' ? 'IDLE' : status.toUpperCase())
                    ),
                    h('div', { className: "flex-1 overflow-y-auto p-2 space-y-1 text-slate-400" },
                        logs.map((l, i) => h('div', { key: i, ref: i === logs.length - 1 ? logEndRef : null }, l))
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(App));
    </script>
</body>

</html>