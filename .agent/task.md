# Task: 修复地图页颜色不一致及视图同步问题

## 已完成修复

### Round 1: 颜色不一致问题
- [x] **修复地图页颜色不一致问题**
  - 修改 `map.html` 的 `closeAIPanel` 函数
  - 实施"先清空状态，再重置样式"的逻辑
  - 添加强制地图重绘 `invalidateSize`
  - 确保同一大区颜色一致

- [x] **修复 deselectAll 函数**
  - 使用 `this.getColor(code)` 重新计算基准色
  - 添加强制重绘 `invalidateSize`

### Round 2: 视图切换同步问题
- [x] **修复从全景页跳转地图页时区域不正确**
  - `panorama.html`: 点击色块时同时上报 `region` 参数到父页面
  - 确保用户点击色块后切换视图时，地图页能跳转到正确的区域

- [x] **修复详情面板显示 undefined**
  - `map.html`: 智能回退逻辑中使用完整的 `itemData` 构造 `currentRegion`
  - 确保 `group` 等属性正确获取

### Round 3: 年份同步问题（方案A）
- [x] **修复从全景页跳转地图页时年份不正确**
  - **问题**: 之前使用 `getCenterYear()` 获取视口中心年份，而非用户点击位置的年份
  - **方案A**: 记录点击时鼠标位置对应的年份（与十字线一致）
  - **实现**:
    1. `panorama.html`: 在 `Core.state` 中添加 `clickedYear` 字段
    2. `panorama.html`: 点击色块时计算 `clickY / zoom + minYear` 得到点击年份
    3. `panorama.html`: 向父页面上报时使用 `clickedYear`
    4. `panorama.html`: `jumpPayload` 优先使用 `clickedYear`，fallback 到 `getCenterYear()`
    5. `index.html`: `REQUEST_SWITCH` 处理中添加 `year` 参数处理

## 验证清单 (请用户操作)

### 1. 验证地图页颜色重置
1. 打开地图页
2. 点击东北地区的"外东北"（打开详情面板，此时会高亮）
3. 点击面板右上角的关闭按钮
4. **验证点**: 观察"外东北"是否恢复为与"松嫩"、"辽东"完全一致的颜色

### 2. 验证年份同步（方案A）
1. 切换到全景页
2. 找到 -12 年位置（视口顶部附近）
3. 点击伊犁区域的"西汉"色块，注意鼠标位置的十字线年份
4. 点击面板标题栏的"🗺️ 查看历史地图"按钮
5. **验证点**:
   - 地图页应显示**伊犁**区域
   - 年份应该是 **-12 年**（与十字线一致，不是视口中心）
   - 西汉应被锁定高亮

### 3. 验证左上角切换按钮
1. 在全景页点击任意政权色块（注意十字线年份）
2. 点击左上角的"空间"按钮切换到地图页
3. **验证点**:
   - 地图页应跳转到**用户点击的区域**
   - 年份应该与**点击时的十字线年份**一致

### 4. 验证清除状态同步
1. 在地图页关闭详情面板
2. 切换回全景页
3. **验证点**: 全景页应清除焦点模式（无政权高亮，背景正常）
