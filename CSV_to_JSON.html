<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rcode CSV 数据转换器 (GeoCode版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .drag-active { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-2xl border border-gray-700 p-6 space-y-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between border-b border-gray-700 pb-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-purple-900/50 rounded-lg">
                    <i data-lucide="file-code" class="w-6 h-6 text-purple-400"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">CSV 数据转换器</h1>
                    <p class="text-xs text-gray-400">基于 GeoCode 映射 (W1-W47)</p>
                </div>
            </div>
            <div class="text-xs text-gray-500 bg-gray-900 px-3 py-1 rounded border border-gray-700 font-mono">
                Key: geo_code
            </div>
        </div>

        <!-- Logic Explanation -->
        <div class="bg-purple-900/20 border border-purple-800 rounded-lg p-4 text-xs text-purple-200 space-y-1">
            <p class="font-bold flex items-center gap-2"><i data-lucide="info" class="w-3 h-3"></i> 映射逻辑说明：</p>
            <ul class="list-disc pl-5 opacity-80">
                <li>自动识别 <strong>geo_code</strong> 并按字母/数字顺序排序。</li>
                <li>排序后的第1个代码映射到 W1，第2个到 W2，以此类推。</li>
                <li><strong>时间处理：</strong> 采用左闭右开原则 [Start, End)。Start==End 时保留。</li>
                <li>年份范围限制：-2070 到 2025。</li>
            </ul>
        </div>

        <!-- Upload Area -->
        <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-xl p-8 flex flex-col items-center justify-center text-center transition-colors cursor-pointer hover:border-gray-500 hover:bg-gray-800/50">
            <input type="file" id="fileInput" accept=".csv" class="hidden" />
            <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-500 mb-3"></i>
            <p class="text-sm font-medium text-gray-300">点击选择或拖拽 CSV 文件</p>
            <p class="text-xs text-gray-500 mt-1">必需列: regime_code, start_year, end_year, <span class="text-purple-400 font-bold">geo_code</span></p>
        </div>

        <!-- Logs / Status -->
        <div id="status-area" class="hidden">
            <div class="bg-black/50 rounded-lg p-4 font-mono text-xs text-gray-400 border border-gray-700 h-40 overflow-y-auto custom-scrollbar" id="log-content">
                <!-- Logs will appear here -->
            </div>
        </div>

        <!-- Actions -->
        <div id="action-area" class="hidden grid-cols-2 gap-4">
            <button onclick="downloadJson()" class="flex items-center justify-center gap-2 bg-green-700 hover:bg-green-600 text-white py-3 rounded-lg font-bold transition shadow-lg active:scale-95">
                <i data-lucide="download" class="w-4 h-4"></i> 下载 JSON 文件
            </button>
            <button onclick="copyJson()" class="flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold transition shadow-lg active:scale-95">
                <i data-lucide="clipboard" class="w-4 h-4"></i> 复制内容 (用于粘贴导入)
            </button>
        </div>

    </div>

    <script>
        // Init Icons
        lucide.createIcons();

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const statusArea = document.getElementById('status-area');
        const actionArea = document.getElementById('action-area');
        const logContent = document.getElementById('log-content');

        let generatedJson = null;

        // Configuration
        const SYSTEM_START_YEAR = -2070;
        const TOTAL_ROWS = 4096;
        const TOTAL_COLS = 47;

        // Drag & Drop Handlers
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) processFile(e.target.files[0]);
        });

        function log(msg, type = 'info') {
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-gray-400');
            const line = document.createElement('div');
            line.className = `mb-1 ${color}`;
            line.innerHTML = `> ${msg}`;
            logContent.appendChild(line);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function processFile(file) {
            statusArea.classList.remove('hidden');
            actionArea.classList.add('hidden');
            logContent.innerHTML = '';
            log(`正在读取文件: ${file.name}...`);

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                convertCsvToJson(text);
            };
            reader.onerror = () => log("读取文件失败", "error");
            reader.readAsText(file);
        }

        function parseCSV(text) {
            // Simple CSV parser handling standard comma-separation
            const lines = text.split(/\r?\n/);
            // Normalize headers: trim whitespace and convert to lowercase
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase()); 
            
            // Validate headers
            const required = ['regime_code', 'start_year', 'end_year', 'geo_code'];
            const missing = required.filter(r => !headers.includes(r));
            if (missing.length > 0) {
                log(`CSV 缺少必要的列头: ${missing.join(', ')}`, 'error');
                log(`请确保 CSV 包含: regime_code, start_year, end_year, geo_code`, 'error');
                return null;
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',');
                // Basic check for row length match (might fail on commas inside quotes, simple parser limitation)
                // Relaxed check: just need enough columns to cover headers
                if (values.length < headers.length) continue; 

                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx] ? values[idx].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        function convertCsvToJson(csvText) {
            const data = parseCSV(csvText);
            if (!data) return;

            log(`CSV 解析成功，共 ${data.length} 行数据。`);
            log("正在根据 geo_code 建立列映射...");

            // 1. Map GeoCode to Columns
            const geoSet = new Set();
            data.forEach(row => { if(row.geo_code) geoSet.add(row.geo_code); });
            
            // Sort by geo_code (Alphabetical/Numerical)
            const sortedGeos = Array.from(geoSet).sort((a, b) => {
                // Try numeric sort if possible, else string sort
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            
            if (sortedGeos.length > TOTAL_COLS) {
                log(`警告: 地区代码数 (${sortedGeos.length}) 超过系统上限 47，将截断。`, 'error');
            }
            
            const validGeos = sortedGeos.slice(0, TOTAL_COLS);
            const geoMap = {};
            validGeos.forEach((geo, idx) => geoMap[geo] = idx);
            
            // Show mapping sample
            const sampleMap = validGeos.length > 5 
                ? `${validGeos.slice(0,3).join(', ')} ... ${validGeos[validGeos.length-1]}`
                : validGeos.join(', ');
            log(`列映射完成 (按 geo_code 排序): [${sampleMap}] -> W1-W${validGeos.length}`);

            // 2. Initialize Grid
            const grid = Array.from({ length: TOTAL_ROWS }, () => 
                Array.from({ length: TOTAL_COLS }, () => [])
            );

            // 3. Fill Data
            let successCount = 0;
            let skipCount = 0;

            data.forEach(row => {
                const geo = row.geo_code;
                if (!geoMap.hasOwnProperty(geo)) return; // Skip unknown/truncated geo

                const rcode = row.regime_code;
                const start = parseInt(row.start_year);
                const end = parseInt(row.end_year);

                if (isNaN(start) || isNaN(end)) return;

                const colIdx = geoMap[geo];

                // Logic: [start, end) unless start == end
                let loopEnd = end;
                if (start === end) loopEnd = start + 1; // Include single year

                for (let year = start; year < loopEnd; year++) {
                    const rowIdx = year - SYSTEM_START_YEAR;
                    
                    if (rowIdx >= 0 && rowIdx < TOTAL_ROWS) {
                        const cell = grid[rowIdx][colIdx];
                        // Add if not duplicate and capacity allows
                        if (!cell.includes(rcode) && cell.length < 4) {
                            cell.push(rcode);
                            successCount++;
                        }
                    } else {
                        skipCount++;
                    }
                }
            });

            // 4. Finalize
            const result = {
                rules: [
                    `来源: Web转换器 (GeoCode版)`,
                    `映射键: geo_code`,
                    `包含地区: ${validGeos.length}个`,
                    `逻辑: 左闭右开 [Start, End)`
                ],
                offset: SYSTEM_START_YEAR,
                grid: grid
            };

            generatedJson = JSON.stringify(result);
            
            log(`转换完成！有效数据点: ${successCount}`, 'success');
            if (skipCount > 0) log(`忽略越界年份数据: ${skipCount} (范围外)`);
            
            actionArea.classList.remove('hidden');
            actionArea.classList.add('grid');
        }

        function downloadJson() {
            if (!generatedJson) return;
            const blob = new Blob([generatedJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rcode_geocode_data_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function copyJson() {
            if (!generatedJson) return;
            navigator.clipboard.writeText(generatedJson).then(() => {
                alert('JSON 内容已复制到剪贴板！\n\n请前往 Rcode 仿真系统 -> 配置 -> 粘贴文本导入。');
            }).catch(() => {
                alert('复制失败，请使用下载功能。');
            });
        }
    </script>
</body>
</html>