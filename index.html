<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸œäºšå†å²äº¤äº’åœ°å›¾ç³»ç»Ÿ (v5.00)</title>

    <!-- ğŸ”‘ å…¨å±€ç‰ˆæœ¬æ§åˆ¶ - ä¿®æ”¹æ­¤å€¼å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç¼“å­˜ -->
    <script>
        window.APP_VERSION = '2026.01.04.001';
        window.APP_CONFIG = {
            VERSION: '5.0.0',
            BUILD_DATE: '2026-01-04',
            // ç¼“å­˜ç‰ˆæœ¬æ£€æŸ¥
            checkCache: function () {
                const storedVersion = localStorage.getItem('APP_VERSION');
                if (storedVersion && storedVersion !== window.APP_VERSION) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–° (' + storedVersion + ' â†’ ' + window.APP_VERSION + ')');
                }
                localStorage.setItem('APP_VERSION', window.APP_VERSION);
            },
            // ä¸º URL æ·»åŠ ç‰ˆæœ¬æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆç”¨äºç¼“å­˜å¤±æ•ˆï¼‰
            withVersion: function (url) {
                if (!url) return url;
                const separator = url.includes('?') ? '&' : '?';
                return url + separator + 'v=' + window.APP_VERSION;
            }
        };
        window.APP_CONFIG.checkCache();
    </script>

    <!-- PapaParse with SRI -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
        crossorigin="anonymous"></script>
    <style>
        /* ... (omitting style for brevity if not matched, but tool needs exact match) */
        /* Wait, I cannot match lines far apart. I will do Title first, then Config. */

        /* --- 1. å…¨å±€å¸ƒå±€ --- */
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            /* é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€è§†å£ */
            overflow: hidden;
            position: fixed;
            /* [Fix] å¼ºåˆ¶é”å®šè§†å£ï¼Œé˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœå’Œæ•´ä½“ä½ç§» */
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0f172a;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            position: fixed;
            /* [Fix] åŒé‡é”å®š */
        }

        .view-container {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            height: calc(100% - 50px);
            border: none;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s ease;
            will-change: transform, opacity;
            background: #0f172a;
        }

        .view-hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.05);
            z-index: 0;
        }

        .view-active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
            z-index: 1;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ  --- */
        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-section.center {
            flex: 1;
            justify-content: center;
            max-width: 400px;
        }

        /* [ä¿®å¤] å³ä¾§å·¥å…·æ å¸ƒå±€ï¼šå¢åŠ å³ä¾§è¾¹è·ï¼Œé˜²æ­¢æº¢å‡ºå±å¹• */
        .header-section.right {
            flex-shrink: 0;
            overflow: visible;
            padding-right: 15px;
            /* å¢åŠ å³è¾¹è· */
            gap: 5px;
        }

        .app-logo {
            font-weight: 900;
            color: #3b82f6;
            font-size: 16px;
            margin-right: 5px;
            white-space: nowrap;
            display: none;
        }

        @media(min-width: 640px) {
            .app-logo {
                display: block;
            }
        }

        .view-switcher {
            background: #1e293b;
            border-radius: 6px;
            padding: 2px;
            display: flex;
            border: 1px solid #334155;
            flex-shrink: 0;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
            font-weight: bold;
        }

        /* å¿«é€Ÿè·³è½¬ä¸‹æ‹‰æ¡† */
        .quick-nav-select {
            background: #1e293b;
            color: #cbd5e1;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            outline: none;
            display: none;
        }

        /* --- æœç´¢æ¡†ä¼˜åŒ– --- */
        .search-container {
            position: relative;
            transition: all 0.3s ease;
            width: 100%;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-box input {
            background: #0f172a;
            border: 1px solid #334155;
            color: #cbd5e1;
            padding: 5px 10px 5px 28px;
            border-radius: 20px;
            font-size: 12px;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-sizing: border-box;
        }

        .search-box input:focus {
            border-color: #3b82f6;
            background: #1e293b;
        }

        .search-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.5;
        }

        @media (max-width: 640px) {
            .search-box input {
                width: 100px;
            }

            .search-container:focus-within .search-box input {
                width: 220px;
                /* ç¨å¾®å‡å°å®½åº¦ä»¥é€‚åº”å°å± */
                position: absolute;
                right: -50px;
                top: 0;
                z-index: 50;
                background: #1e293b;
                border-color: #3b82f6;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            }
        }

        .header-section.right.search-active> :not(#toolbox-dropdown) {
            opacity: 0.2;
            pointer-events: none;
        }

        #search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-top: 5px;
            display: none;
            z-index: 10002;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .suggestion-item {
            padding: 8px 12px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            color: #cbd5e1;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: #3b82f6;
            color: white;
        }

        .suggestion-tag {
            font-size: 10px;
            opacity: 0.7;
            border: 1px solid currentColor;
            padding: 0 4px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 2px;
        }

        .zoom-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            padding-top: 10px;
            min-width: 220px;
            z-index: 10001;
        }

        .dropdown-inner {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-inner a {
            color: #cbd5e1;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            transition: background 0.1s;
        }

        .dropdown-inner a:hover {
            background: #3b82f6;
            color: white;
        }

        .api-input-container {
            padding: 10px 15px;
            border-bottom: 1px solid #334155;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .api-label {
            font-size: 10px;
            color: #94a3b8;
            font-weight: bold;
        }

        .api-input {
            width: 100%;
            background: #0f172a;
            border: 1px solid #475569;
            color: #fff;
            padding: 6px;
            border-radius: 4px;
            font-size: 11px;
            box-sizing: border-box;
            font-family: monospace;
        }

        .api-input:focus {
            border-color: #3b82f6;
            outline: none;
        }

        /* --- 3. å›¾ä¾‹é¢æ¿ --- */
        #global-legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 320px;
            z-index: 9998;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            padding: 15px;
            color: #cbd5e1;
            font-size: 12px;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 70vh;
            overflow-y: auto;
        }

        #global-legend.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .legend-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            color: #94a3b8;
        }

        .legend-swatch {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .legend-title {
            font-weight: bold;
            color: #e2e8f0;
            margin: 10px 0 6px 0;
            border-bottom: 1px solid #334155;
            padding-bottom: 2px;
            clear: both;
        }

        /* çº¹ç†é¢„è§ˆ */
        .preview-C {
            background: linear-gradient(0deg, #555 0%, #333 100%);
        }

        .preview-Q {
            background: linear-gradient(135deg, #666 0%, #333 50%);
        }

        .preview-R {
            background: repeating-linear-gradient(45deg, #444, #444 4px, #333 4px, #333 8px);
        }

        .preview-N {
            background: repeating-linear-gradient(45deg, #555 0, #555 1px, transparent 1px, transparent 4px), repeating-linear-gradient(-45deg, #555 0, #555 1px, transparent 1px, transparent 4px);
            background-color: #333;
        }

        .preview-F {
            background: repeating-linear-gradient(120deg, #555 0, #555 2px, transparent 2px, transparent 6px);
            background-color: #333;
        }

        .preview-T {
            background: radial-gradient(#aaa 1px, transparent 1px);
            background-size: 5px 5px;
            background-color: #333;
        }

        .preview-V {
            border: 2px dashed #aaa;
            background: transparent;
        }

        .preview-J {
            background-color: #333;
            background-image: linear-gradient(#999 1px, transparent 1px), linear-gradient(90deg, #999 1px, transparent 1px);
            background-size: 8px 8px;
        }

        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.5s;
            pointer-events: auto;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #debug-console {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background: rgba(0, 0, 0, 0.95);
            color: #00ff00;
            font-family: 'Menlo', monospace;
            font-size: 11px;
            z-index: 20000;
            border-top: 2px solid #333;
            flex-direction: column;
        }

        #debug-trigger {
            position: fixed;
            bottom: 5px;
            left: 5px;
            z-index: 20001;
            opacity: 0.3;
            cursor: pointer;
            font-size: 20px;
        }

        #debug-trigger:hover {
            opacity: 1;
        }

        #debug-toolbar {
            padding: 5px;
            background: #222;
            border-bottom: 1px solid #444;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #debug-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .dbg-btn {
            background: #444;
            border: 1px solid #666;
            color: white;
            padding: 2px 8px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .dbg-btn:hover {
            background: #666;
        }

        .log-error {
            color: #ff5555;
            background: rgba(255, 0, 0, 0.1);
            padding: 2px 0;
            border-bottom: 1px solid #500;
        }

        .log-warn {
            color: #f1c40f;
        }

        #io-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 11000;
            align-items: center;
            justify-content: center;
        }

        .io-content {
            background: #1e293b;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            border: 1px solid #475569;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .io-header {
            padding: 15px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .io-body {
            padding: 0;
            flex: 1;
        }

        #io-textarea {
            width: 100%;
            height: 300px;
            background: #020617;
            color: #a5f3fc;
            border: none;
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            resize: none;
            outline: none;
        }

        .io-footer {
            padding: 10px;
            background: #0f172a;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-secondary {
            background: #334155;
            color: #cbd5e1;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* å¾®ç‚¹æ¨¡å¼æ ·å¼ */
        .era-dot {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
            pointer-events: auto;
        }

        .era-dot:hover {
            background-color: #fff;
            box-shadow: 0 0 10px #fff;
        }

        .era-label {
            transform: translate(-50%, 0);
            text-align: center;
            line-height: 1.1;
        }
    </style>
</head>

<body>

    <div id="global-loader">
        <div class="spinner"></div>
        <div id="loader-text" style="font-size:12px; font-family:monospace; color:#94a3b8;">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <header id="main-header">
        <div class="header-section left">
            <div class="app-logo">ä¸œäºšå†å²åœ°å›¾</div>
            <div class="view-switcher">
                <button id="tab-map" class="tab-btn active" onclick="window.EastAsiaApp.switchView('map')">ç©ºé—´</button>
                <button id="tab-pano" class="tab-btn" onclick="window.EastAsiaApp.switchView('panorama')">å…¨æ™¯</button>
            </div>
            <select id="quick-nav" class="quick-nav-select"
                onchange="window.EastAsiaApp.setState({year: parseInt(this.value)}); this.selectedIndex = 0;">
                <option value="" selected>â±ï¸ è·³è½¬</option>
                <option value="-2070">å¤å•†</option>
                <option value="-1046">å‘¨</option>
                <option value="-221">ç§¦æ±‰</option>
                <option value="581">éš‹å”</option>
                <option value="960">å®‹å…ƒ</option>
                <option value="1368">æ˜æ¸…</option>
                <option value="1912">ç°ä»£</option>
            </select>
        </div>

        <div class="header-section center">
            <div class="search-container" id="search-container">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="global-search" placeholder="æœç´¢æ”¿æƒ / åœ°ç‚¹..." autocomplete="off">
                </div>
                <div id="search-suggestions"></div>
            </div>
        </div>

        <div class="header-section right" id="header-right">
            <div class="dropdown" id="toolbox-dropdown">
                <button class="icon-btn" title="å·¥å…·ç®±">ğŸ› ï¸</button>
                <div class="dropdown-content">
                    <div class="dropdown-inner">
                        <div class="api-input-container">
                            <span class="api-label">GEMINI API KEY</span>
                            <input type="password" id="gemini-key" class="api-input" placeholder="åœ¨æ­¤ç²˜è´´ Key"
                                onchange="window.EastAsiaApp.saveApiKey(this.value)">
                        </div>
                        <a onclick="window.GlobalUtils.showAbout()">â„¹ï¸ å…³äºé¡¹ç›®</a>
                        <a onclick="window.open('LayoutOptimizer.html?autorun=true', '_blank')">ğŸ“ é‡æ–°è®¡ç®—å¸ƒå±€ (è·³è½¬)</a>
                        <a onclick="window.EastAsiaApp.refreshData()">ğŸ”„ åˆ·æ–°æ•°æ® (å¼ºåˆ¶é‡è½½)</a>
                        <a onclick="window.EastAsiaApp.clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</a>
                        <a onclick="window.EastAsiaApp.toggleLegend(event)">ğŸ“– å›¾ä¾‹é¢æ¿</a>
                        <div class="divider" style="height:1px; width:100%; background:#334155; margin:4px 0;"></div>
                        <a id="btn-antique" onclick="window.EastAsiaApp.toggleAntique()">ğŸ“œ ä»¿å¤å·²å¼€</a>
                        <a id="btn-borders" onclick="window.EastAsiaApp.toggleBorders()">ğŸ—ºï¸ çœç•Œå·²å…³</a>
                        <a onclick="window.EastAsiaApp.openIoModal()">ğŸ’¾ å¯¼å‡ºå¯¼å…¥åæ ‡</a>
                        <div class="divider" style="height:1px; width:100%; background:#334155; margin:4px 0;"></div>
                        <a id="btn-connections" onclick="window.EastAsiaApp.toggleConnections()">ğŸ”— çº½å¸¦å·²å¼€</a>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="zoom-controls">
                <button class="icon-btn" onclick="window.EastAsiaApp.resetAll()" title="å…¨å±€å¤ä½">âŸ²</button>
                <button class="icon-btn" onclick="window.EastAsiaApp.broadcast('CMD_ZOOM_OUT')">ï¼</button>
                <button class="icon-btn" onclick="window.EastAsiaApp.broadcast('CMD_ZOOM_IN')">ï¼‹</button>
            </div>
        </div>
    </header>

    <div id="global-legend">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <strong>å›¾ä¾‹æŒ‡å—</strong>
            <span style="cursor:pointer"
                onclick="document.getElementById('global-legend').classList.remove('active')">âœ•</span>
        </div>
        <div class="legend-title">æ”¿æƒç±»å‹</div>
        <div class="legend-grid">
            <div class="legend-row">
                <div class="legend-swatch preview-C"></div>ä¸­åŸå¸å›½ (æ¸å˜)
            </div>
            <div class="legend-row">
                <div class="legend-swatch preview-Q"></div>å¾æœç‹æœ (å…‰æ³½)
            </div>
            <div class="legend-row">
                <div class="legend-swatch preview-R"></div>å‰²æ®åˆ—å›½ (æ¡çº¹)
            </div>
            <div class="legend-row">
                <div class="legend-swatch preview-N"></div>åŸç”Ÿéƒ¨æ— (ç½‘æ ¼)
            </div>
            <div class="legend-row">
                <div class="legend-swatch preview-F"></div>è¾¹ç–†æ”¿æƒ (æ–œçº¹)
            </div>
            <div class="legend-row">
                <div class="legend-swatch preview-T"></div>è¿‡æ¸¡æ”¿æƒ (ç‚¹é˜µ)
            </div>
        </div>
        <div class="legend-title">ç‰¹æ®Šå…³ç³»</div>
        <div class="legend-row">
            <div class="legend-swatch preview-V"></div>è—©å±å…³ç³» (è™šçº¿)
        </div>
        <div class="legend-row">
            <div class="legend-swatch preview-J"></div>ç¾ç¸»å…³ç³» (æ­£æ–¹æ ¼)
        </div>
        <div class="legend-title">æ¿å—è‰²ç³»</div>
        <div class="legend-grid">
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(0,70%,45%)"></div>é»„æ²³æ ¸å¿ƒ
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(125,70%,40%)"></div>é•¿æ±Ÿæ ¸å¿ƒ
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(170,70%,40%)"></div>å—æ–¹è¾¹ç–†
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(280,60%,45%)"></div>é’è—é«˜åŸ
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(35,80%,50%)"></div>è¥¿åŸŸæ–°ç–†
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(80,70%,35%)"></div>è’™å¤è‰åŸ
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(210,70%,45%)"></div>ä¸œåŒ—åœ°åŒº
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(245,70%,45%)"></div>æœé²œåŠå²›
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(320,70%,45%)"></div>æ—¥æœ¬åˆ—å²›
            </div>
            <div class="legend-row">
                <div class="legend-swatch" style="background:hsl(0,0%,50%)"></div>æ¬§ç¾å…¶ä»–
            </div>
        </div>
    </div>

    <div id="io-modal">
        <div class="io-content">
            <div class="io-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>åœ°å›¾åæ ‡æ•°æ® (GeoJSON)</span>
                    <button class="btn-primary" style="padding:2px 8px; font-size:10px;"
                        onclick="window.EastAsiaApp.openIoModal()">ğŸ”„ è·å–/åˆ·æ–°</button>
                </div>
                <button onclick="document.getElementById('io-modal').style.display='none'" class="icon-btn"
                    style="border:none">âœ•</button>
            </div>
            <div class="io-body">
                <textarea id="io-textarea" spellcheck="false" placeholder="ç‚¹å‡»â€œåº”ç”¨â€å¯åŠ è½½ GeoJSON æ•°æ®é¢„è§ˆ..."></textarea>
            </div>
            <div class="io-footer">
                <span style="margin-right:auto; font-size:10px; color:#64748b; line-height:28px;">* ä»…ç”¨äºé¢„è§ˆæˆ–å»ä»£ç ä¸­æ›´æ–°</span>
                <button class="btn-secondary" onclick="window.EastAsiaApp.copyIoContent()">ğŸ“‹ å¤åˆ¶</button>
                <button class="btn-primary" onclick="window.EastAsiaApp.applyIoContent()">â–¶ï¸ åº”ç”¨å¹¶é¢„è§ˆ</button>
            </div>
        </div>
    </div>

    <iframe id="iframe-map" src="map.html?v=3.03" class="view-container view-active"></iframe>
    <iframe id="iframe-panorama" src="panorama.html?v=3.03" class="view-container view-hidden"></iframe>

    <div id="debug-trigger" onclick="document.getElementById('debug-console').style.display='flex'">ğŸ</div>
    <div id="debug-console">
        <div id="debug-content"></div>
        <div id="debug-toolbar">
            <button class="dbg-btn" onclick="window.EastAsiaApp.copyDebug()">å¤åˆ¶æ—¥å¿—</button>
            <button class="dbg-btn" onclick="document.getElementById('debug-content').innerHTML=''">æ¸…ç©º</button>
            <button class="dbg-btn" onclick="document.getElementById('debug-console').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <script>
        // [Critical Fix] é’ˆå¯¹ iOS Safari çš„å¼ºåˆ¶é˜²ç¼©æ”¾è¡¥ä¸
        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
        document.addEventListener('touchmove', function (e) { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // --- Shared Styles (CSSå˜é‡å®šä¹‰) ---
        const SHARED_CSS_STYLES = `
        /* åŸºç¡€çº¹ç† - å¢å¤§å°ºå¯¸ä»¥å‡è½»æ‘©å°”çº¹ (Anti-Aliasing Optimized) */
        .texture-C { background-image: linear-gradient(0deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%); }
        .texture-Q { background-image: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%); }
        .texture-R { background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 4px, transparent 4px, transparent 12px); }
        .texture-F { background-image: repeating-linear-gradient(120deg, rgba(255,255,255,0.15) 0, rgba(255,255,255,0.15) 3px, transparent 3px, transparent 9px); }
        .texture-N { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.15) 0, rgba(255,255,255,0.15) 2px, transparent 2px, transparent 8px), repeating-linear-gradient(-45deg, rgba(255,255,255,0.15) 0, rgba(255,255,255,0.15) 2px, transparent 2px, transparent 8px); }
        .texture-T { background-image: radial-gradient(rgba(255,255,255,0.4) 1.5px, transparent 1.5px); background-size: 8px 8px !important; }
        
        /* é»˜è®¤è§†è§‰å±‚çº§æ§åˆ¶ï¼šå¾®ç° (0.85)ï¼Œä¿ç•™è´¨æ„Ÿ */
        .fragment, .timeline-slice, .regime-block, .era-block-fragment, .regime-slice {
            filter: saturate(0.85) brightness(0.95);
            transition: filter 0.2s ease;
        }

        /* Hover çŠ¶æ€ï¼šæ¢å¤é²œæ´»ï¼Œè½»å¾®æäº®ï¼Œå±‚çº§ç»Ÿä¸€ */
        /* [Extreme Fix] ç§»é™¤æ‰€æœ‰ä¼ªç±»é€‰æ‹©å™¨ï¼Œå®Œå…¨ä¾èµ– JS æ·»åŠ çš„ .group-hovered ç±» */
        /* è¿™æ ·ç¡®ä¿é¼ æ ‡æ‚¬åœçš„ç›®æ ‡(Target)ä¸åŒç»„å…„å¼Ÿ(Siblings)æ‹¥æœ‰å®Œå…¨ç›¸åŒçš„æ ·å¼æƒé‡ï¼Œæ¶ˆé™¤è§†è§‰å·®å¼‚ */
        /* [Extreme Fix] å…¨æ™¯å›¾(Panorama)å®Œå…¨ä¾èµ– .group-hovered ç±»ä»¥ä¿è¯ä¸€è‡´æ€§ */
        .group-hovered {
            filter: saturate(1.1) brightness(1.05) !important;
            z-index: 50 !important;
            box-shadow: none !important;
        }
        
        /* åœ°å›¾(Map)å’Œä¼˜åŒ–å™¨(Optimizer)ç»§ç»­ä½¿ç”¨ :hover ä¼ªç±» */
        .timeline-slice:hover, .regime-slice:hover, .regime-block:hover {
            filter: saturate(1.05) brightness(1.02) !important;
            z-index: 50 !important;
            box-shadow: none !important;
        }

        /* ç‰¹æ®Šå…³ç³» - ä¿®æ­£ä¸ºä¸è¦†ç›–èƒŒæ™¯å›¾ï¼Œåªæ·»åŠ è¾¹æ¡† */
        .texture-V { border-style: dashed !important; border-width: 2px !important; }
        
        /* ç¾ç¸» (J) - æ­£æ–¹æ ¼ç½‘æ ¼ */
        .texture-J { 
            background-image: 
                linear-gradient(0deg, var(--pat-color, rgba(255,255,255,0.3)) 1px, transparent 1px), 
                linear-gradient(90deg, var(--pat-color, rgba(255,255,255,0.3)) 1px, transparent 1px) !important; 
            background-size: 8px 8px !important; 
        }
        
        /* åŒé‡ (VJ): æ­£æ–¹æ ¼ + è™šçº¿è¾¹æ¡† */
        .texture-VJ {
            border-style: dashed !important; border-width: 2px !important;
            background-image: 
                linear-gradient(0deg, var(--pat-color, rgba(255,255,255,0.3)) 1px, transparent 1px), 
                linear-gradient(90deg, var(--pat-color, rgba(255,255,255,0.3)) 1px, transparent 1px) !important; 
            background-size: 8px 8px !important; 
        }
        
        /* é€‰ä¸­/èšç„¦çŠ¶æ€ (æœ€é«˜ä¼˜å…ˆçº§) */
        .is-focused, .active-locked {
            filter: brightness(1.3) contrast(1.1) saturate(1.2) !important;
            box-shadow: 0 0 0 2px white, 0 4px 15px rgba(0,0,0,0.8) !important;
            z-index: 1000 !important;
            opacity: 1 !important; transform: scale(1.02);
        }
    `;

        const GLOBAL_CONFIG = {
            TIME: { MIN_YEAR: -2100, MAX_YEAR: 2025, CURRENT_YEAR: new Date().getFullYear(), DEFAULT_START: -200, PRESENT_YEAR: 2025 },
            FALLBACK_STYLE: { bg: '#666', border: '#444', className: 'texture-C', isDashed: false, textColor: '#fff' }
        };

        window.GlobalUtils = {
            getStyle: function (regimeCode, name, suzerainCode, suzerainType) {
                if (window.EastAsiaApp && window.EastAsiaApp.getStyle) {
                    return window.EastAsiaApp.getStyle(regimeCode, name, suzerainCode, suzerainType);
                }
                return GLOBAL_CONFIG.FALLBACK_STYLE;
            },

            showToast: function (msg, duration = 2000) {
                const containerId = 'global-toast-container';
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:999999;pointer-events:none';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                toast.textContent = msg;
                toast.style.cssText = 'background:rgba(30,41,59,0.95);color:#e2e8f0;padding:12px 20px;border-radius:8px;margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,0.4);border:1px solid #475569;font-size:13px;opacity:0;transition:opacity 0.3s;pointer-events:auto';
                container.appendChild(toast);
                requestAnimationFrame(() => toast.style.opacity = '1');
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, duration);
            },

            safeExec: function (fn, context) {
                try { if (typeof fn === 'function') fn.call(context || this); else console.error("safeExec called with non-function"); }
                catch (e) { console.error(`æ“ä½œå¤±è´¥: ${e.message}`); }
            },
            showAbout: async function () {
                const getVer = async (url) => {
                    try {
                        const res = await fetch(url);
                        const text = await res.text();
                        const match = text.match(/<title>.*?(v[\d.]+).*?<\/title>/i);
                        return match ? match[1] : 'v?.??';
                    } catch (e) { return 'N/A'; }
                };

                // Current (Index)
                const vIndex = document.title.match(/v([\d.]+)/) ? 'v' + document.title.match(/v([\d.]+)/)[1] : 'v4.00';

                // Async Fetch others
                const vMap = await getVer('map.html');
                const vPano = await getVer('panorama.html');
                const vLayout = await getVer('LayoutOptimizer.html');

                alert(`EastAsia History Map System\n\n` +
                    `Core: ${vIndex}\n` +
                    `Map Engine: ${vMap}\n` +
                    `Panorama Engine: ${vPano}\n` +
                    `Layout Opt: ${vLayout}\n\n` +
                    `Last Sync: ${new Date().toLocaleDateString()}`);
            }
        };

        // --- Main Logic ---
        window.EastAsiaApp = {
            config: {
                cloudCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMSHMYH-_pI-2v9bqP-1Balz19zzjAW9QyykU5D1GsfnGVV4Xt-OwPjOlFKPwQL2rQ9EVGCgl7ikCs/pub?gid=0&single=true&output=csv",
                localCsv: "./history_data.csv",
                cacheKey: "ea_history_csv_v1",
                apiKeyStorage: "ea_gemini_key"
            },

            state: {
                // === æ ¸å¿ƒå…¨å±€çŠ¶æ€ï¼ˆå•ä¸€æ•°æ®æºï¼‰===
                currentView: 'map',          // map | panorama
                year: -220,                  // å½“å‰æ—¶é—´ç‚¹
                selectedRegime: null,        // å½“å‰é€‰ä¸­æ”¿æƒID
                locked: false,               // æ˜¯å¦é”å®šæ”¿æƒ
                focusMode: false,            // AIé¢æ¿æ˜¯å¦æ¿€æ´»

                // === ç³»ç»ŸçŠ¶æ€ ===
                dataReady: false,
                rawData: null,
                framesReady: { map: false, panorama: false },
                apiKey: "",
                features: { antique: true, borders: false, connections: true }
            },

            // === çŠ¶æ€ç®¡ç†æ ¸å¿ƒï¼ˆå•å‘æ•°æ®æµï¼‰===
            _stateListeners: new Set(),

            /**
             * è®¾ç½®çŠ¶æ€ï¼ˆå”¯ä¸€ä¿®æ”¹stateçš„å…¥å£ï¼‰
             * @param {Object} patch - è¦æ›´æ–°çš„çŠ¶æ€ç‰‡æ®µ
             * @param {Object} options - é€‰é¡¹ { silent: boolean, skipURL: boolean }
             */
            setState: function (patch, options = {}) {
                const oldState = { ...this.state };

                // 1. åˆå¹¶çŠ¶æ€
                Object.assign(this.state, patch);

                // 2. åŒæ­¥åˆ°URLï¼ˆé™¤éæ˜¾å¼è·³è¿‡ï¼‰
                if (!options.skipURL) {
                    this.syncStateToURL();
                }

                // 3. è§¦å‘è®¢é˜…è€…ï¼ˆé™¤éé™é»˜æ¨¡å¼ï¼‰
                if (!options.silent) {
                    this._stateListeners.forEach(fn => {
                        try {
                            fn(this.state, oldState, patch);
                        } catch (e) {
                            console.error('[State] Listener error:', e);
                        }
                    });
                }

                // 4. å¹¿æ’­åˆ°æ‰€æœ‰iframe
                this.broadcastStateSync();

                // 5. è°ƒè¯•æ—¥å¿—
                if (Object.keys(patch).length > 0) {
                    console.log('[State] Updated:', patch);
                }
            },

            /**
             * è®¢é˜…çŠ¶æ€å˜åŒ–
             * @param {Function} callback - (newState, oldState, patch) => void
             * @returns {Function} å–æ¶ˆè®¢é˜…å‡½æ•°
             */
            subscribe: function (callback) {
                this._stateListeners.add(callback);
                // ç«‹å³è§¦å‘ä¸€æ¬¡ï¼ˆåˆå§‹åŒ–ï¼‰
                callback(this.state, {}, this.state);
                // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
                return () => this._stateListeners.delete(callback);
            },

            /**
             * è·å–å½“å‰çŠ¶æ€ï¼ˆåªè¯»å‰¯æœ¬ï¼‰
             */
            getState: function () {
                return { ...this.state };
            },

            /**
             * åŒæ­¥çŠ¶æ€åˆ°URLï¼ˆæ”¯æŒåˆ†äº«å’Œåˆ·æ–°æ¢å¤ï¼‰
             */
            syncStateToURL: function () {
                const params = new URLSearchParams();

                // åªåŒæ­¥æ ¸å¿ƒçŠ¶æ€
                if (this.state.year !== -220) params.set('year', this.state.year);
                if (this.state.selectedRegime) params.set('regime', this.state.selectedRegime);
                if (this.state.currentView !== 'map') params.set('view', this.state.currentView);
                if (this.state.locked) params.set('locked', '1');

                const queryString = params.toString();
                const newURL = queryString ? '?' + queryString : window.location.pathname;

                // ä½¿ç”¨ replaceState é¿å…ç ´åæµè§ˆå™¨å†å²
                window.history.replaceState(null, '', newURL);
            },

            /**
             * ä»URLæ¢å¤çŠ¶æ€ï¼ˆå¯åŠ¨æ—¶è°ƒç”¨ï¼‰
             */
            restoreStateFromURL: function () {
                const params = new URLSearchParams(window.location.search);
                const patch = {};

                if (params.has('year')) {
                    const year = parseInt(params.get('year'));
                    if (!isNaN(year)) patch.year = year;
                }
                if (params.has('regime')) patch.selectedRegime = params.get('regime');
                if (params.has('view')) patch.currentView = params.get('view');
                if (params.has('locked')) patch.locked = true;

                if (Object.keys(patch).length > 0) {
                    this.setState(patch, { skipURL: true }); // é¿å…å¾ªç¯
                    console.log('[State] Restored from URL:', patch);
                }
            },

            /**
             * å¹¿æ’­çŠ¶æ€åˆ°æ‰€æœ‰iframeï¼ˆå•å‘æ•°æ®æµï¼šçˆ¶â†’å­ï¼‰
             */
            broadcastStateSync: function () {
                const message = {
                    type: 'STATE_SYNC',
                    payload: this.state
                };

                const mapFrame = document.getElementById('iframe-map');
                const panoFrame = document.getElementById('iframe-panorama');

                if (mapFrame && mapFrame.contentWindow && this.state.framesReady.map) {
                    mapFrame.contentWindow.postMessage(message, window.location.origin);
                }
                if (panoFrame && panoFrame.contentWindow && this.state.framesReady.panorama) {
                    panoFrame.contentWindow.postMessage(message, window.location.origin);
                }
            },

            init: function () {
                const originalLog = console.log;
                const originalWarn = console.warn;
                const originalError = console.error;
                const dbg = document.getElementById('debug-content');

                const appendLog = (args, type) => {
                    if (!dbg) return;
                    const div = document.createElement('div');

                    // 1. Format Message with Object Expansion (Truncated)
                    const msg = args.map(arg => {
                        if (typeof arg === 'object' && arg !== null) {
                            try {
                                const str = JSON.stringify(arg, null, 2);
                                return str.length > 200 ? str.substring(0, 200) + '... [Truncated]' : str;
                            } catch (e) { return '[Circular Object]'; }
                        }
                        return String(arg);
                    }).join(' ');

                    // 2. Visual Polish
                    const time = new Date().toLocaleTimeString();
                    let prefix = 'â„¹ï¸';
                    if (type === 'warn') prefix = 'âš ï¸';
                    if (type === 'error') prefix = 'âŒ';

                    // 3. Simple Tag Highlighting (e.g., [Layout] -> Bold Color)
                    let formattedMsg = msg;
                    if (msg.startsWith('[')) {
                        const tagEnd = msg.indexOf(']');
                        if (tagEnd > -1) {
                            const tag = msg.substring(0, tagEnd + 1);
                            const rest = msg.substring(tagEnd + 1);
                            formattedMsg = `<span style="color:#00ffff;font-weight:bold">${tag}</span>${rest}`;
                        }
                    }

                    div.innerHTML = `<span style="opacity:0.6">[${time}]</span> ${prefix} ${formattedMsg.replace(/\n/g, '<br>').replace(/  /g, '&nbsp;&nbsp;')}`;

                    if (type === 'error') div.className = 'log-error';
                    if (type === 'warn') div.className = 'log-warn';

                    div.style.borderBottom = "1px solid #222";
                    div.style.padding = "4px 0";  // Better spacing

                    dbg.appendChild(div);
                    dbg.scrollTop = dbg.scrollHeight;
                };

                console.log = function (...args) { originalLog.apply(console, args); appendLog(args, 'log'); };
                console.warn = function (...args) { originalWarn.apply(console, args); appendLog(args, 'warn'); };
                console.error = function (...args) { originalError.apply(console, args); appendLog(args, 'error'); };

                window.onerror = function (msg, source, line, col, error) {
                    console.error(`Uncaught Error: ${msg} @ ${source}:${line}`);
                    return false;
                };
                window.onunhandledrejection = function (event) {
                    console.error(`Unhandled Promise: ${event.reason}`);
                };

                this.log("System Initializing...");

                const savedKey = localStorage.getItem(this.config.apiKeyStorage);
                if (savedKey) {
                    this.state.apiKey = savedKey;
                    document.getElementById('gemini-key').value = savedKey;
                }

                if (this.loadFromCache()) {
                    this.log("Loaded data from local cache.");
                } else {
                    this.fetchData();
                }

                window.addEventListener('message', (e) => {
                    if (e.data.type === 'CMD_GEOJSON_DATA') {
                        const payload = e.data.payload;
                        const textarea = document.getElementById('io-textarea');

                        // [ä¿®æ”¹] æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ˜¾ç¤ºï¼ˆä¿æŒæ ¼å¼ï¼‰ï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ‰æ ¼å¼åŒ– JSON
                        if (typeof payload === 'string') {
                            textarea.value = payload;
                        } else {
                            textarea.value = JSON.stringify(payload, null, 2);
                        }

                        document.getElementById('io-modal').style.display = 'flex';
                    }
                    this.handleMessage(e);
                });

                document.addEventListener('click', (e) => {
                    const legend = document.getElementById('global-legend');
                    if (legend.classList.contains('active') &&
                        !legend.contains(e.target) &&
                        !e.target.closest('#toolbox-dropdown')) {
                        legend.classList.remove('active');
                    }
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('search-suggestions').style.display = 'none';
                    }
                });

                const searchInput = document.getElementById('global-search');
                const searchBox = document.querySelector('.search-box');
                const headerRight = document.getElementById('header-right');

                if (searchInput) {
                    searchInput.addEventListener('focus', () => {
                        document.querySelector('.search-container').classList.add('active');
                        if (window.innerWidth <= 640) headerRight.classList.add('search-active');
                    });

                    searchInput.addEventListener('input', (e) => this.handleSearchInput(e.target.value));

                    searchInput.addEventListener('blur', () => {
                        setTimeout(() => {
                            document.querySelector('.search-container').classList.remove('active');
                            headerRight.classList.remove('search-active');
                            document.getElementById('search-suggestions').style.display = 'none';
                        }, 200);
                    });
                }
                this.updateButtonStates();

                // === ä»URLæ¢å¤çŠ¶æ€ï¼ˆæ”¯æŒURLåˆ†äº«ï¼‰ ===
                this.restoreStateFromURL();

                // === è®¢é˜…çŠ¶æ€å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°UI ===
                this.subscribe((newState, oldState, patch) => {
                    // è§†å›¾åˆ‡æ¢æ—¶æ›´æ–°UI
                    if (patch.currentView) {
                        this._updateViewUI(newState.currentView);
                    }
                });
            },

            log: function (msg) {
                console.log(msg);
            },

            saveApiKey: function (key) {
                // 1. æ ¸å¿ƒå­˜å‚¨é€»è¾‘ (ä¿æŒä¸å˜)
                this.state.apiKey = key;
                localStorage.setItem(this.config.apiKeyStorage, key);
                this.broadcast('CMD_CONFIG_UPDATE', { apiKey: key });

                // 2. ã€æ–°å¢ã€‘UI è§†è§‰åé¦ˆ
                const inputEl = document.getElementById('gemini-key');
                if (inputEl) {
                    const originalBorder = inputEl.style.borderColor;
                    // å˜ç»¿æç¤ºæˆåŠŸ
                    inputEl.style.borderColor = '#00ff9d';
                    inputEl.style.backgroundColor = '#064e3b'; // æ·±ç»¿èƒŒæ™¯

                    // 1ç§’åæ¢å¤åŸçŠ¶
                    setTimeout(() => {
                        inputEl.style.borderColor = originalBorder || '#475569';
                        inputEl.style.backgroundColor = '#0f172a';
                    }, 1000);
                }
                this.log("API Key å·²ä¿å­˜è‡³ LocalStorage");
            },

            toggleLegend: function (e) {
                if (e) e.stopPropagation();
                document.getElementById('global-legend').classList.toggle('active');
            },

            refreshData: function () {
                if (confirm("ç¡®å®šè¦å¼ºåˆ¶é‡æ–°ä»äº‘ç«¯/æœ¬åœ°åŠ è½½æ•°æ®å—ï¼Ÿ")) {
                    this.state.dataReady = false;
                    localStorage.removeItem(this.config.cacheKey);
                    location.reload();
                }
            },

            openIoModal: function () {
                this.log("Requesting GeoJSON from Map...");
                this.broadcast('CMD_REQ_GEOJSON');
            },
            copyIoContent: function () {
                const txt = document.getElementById('io-textarea');
                txt.select();
                document.execCommand('copy');
                alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
            },
            applyIoContent: function () {
                try {
                    const json = JSON.parse(document.getElementById('io-textarea').value);
                    this.broadcast('CMD_SET_GEOJSON', json);
                    document.getElementById('io-modal').style.display = 'none';
                    alert("æ–°åæ ‡å·²åº”ç”¨ (ä»…é¢„è§ˆï¼Œåˆ·æ–°åå¤±æ•ˆ)");
                } catch (e) {
                    alert("JSON æ ¼å¼é”™è¯¯: " + e.message);
                }
            },
            copyDebug: function () {
                const txt = document.getElementById('debug-content').innerText;
                navigator.clipboard.writeText(txt).then(() => alert("æ—¥å¿—å·²å¤åˆ¶"));
            },

            loadFromCache: function () {
                try {
                    const cached = localStorage.getItem(this.config.cacheKey);
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                            // [Fix] ç­‰å¾… Layout åŠ è½½å®Œæˆåå†å¤„ç†æ•°æ®ï¼Œç¡®ä¿å¹¿æ’­æ—¶åŒ…å« Layout
                            this.loadAndCheckLayout(null, () => {
                                this.processData(parsed);
                            });
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn("Cache load failed", e);
                }
                return false;
            },

            saveToCache: function (data) {
                try {
                    localStorage.setItem(this.config.cacheKey, JSON.stringify(data));
                } catch (e) {
                    console.warn("Cache save failed", e);
                }
            },

            fetchData: function () {
                const updateLog = (msg) => {
                    const el = document.getElementById('loader-text');
                    if (el) el.innerText = msg;
                    this.log(msg);
                };

                updateLog("æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...");
                let cloudDone = false;
                const cloudUrl = this.config.cloudCsv;

                // [Refactor] ä½¿ç”¨ fetch è·å–æ–‡æœ¬ä»¥ä¾¿è®¡ç®— Hashï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ Papa.parse
                const fetchCloud = async () => {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s Timeout

                        const response = await fetch(cloudUrl, { signal: controller.signal });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const text = await response.text();

                        clearTimeout(timeoutId);
                        if (cloudDone) return;
                        cloudDone = true;

                        // 1. è®¡ç®— Hash å¹¶æ ¡éªŒä¸€è‡´æ€§ (åŒæ—¶åŠ è½½ Layout)
                        const hash = this.simpleHash(text);
                        this.loadAndCheckLayout(hash);

                        // 2. è§£æ
                        Papa.parse(text, {
                            header: true, skipEmptyLines: true,
                            transform: (val) => val.trim(), // [Fix] Trim whitespace to match LayoutOptimizer logic
                            complete: (results) => {
                                console.log(`âœ… Cloud Data Loaded: ${results.data.length} records`);
                                this.saveToCache(results.data);
                                this.processData(results.data);
                            }
                        });

                    } catch (err) {
                        if (cloudDone) return;
                        cloudDone = true;
                        console.warn("âš ï¸ Cloud failed or timeout:", err);
                        updateLog("äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢æœ¬åœ°å¤‡ä»½...");
                        this.loadLocal(updateLog);
                    }
                };

                fetchCloud();
            },

            // [New] ç®€æ˜“ Hash (ä¸ LayoutOptimizer ä¿æŒä¸€è‡´)
            simpleHash: (str) => { let h = 5381; for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i); return (h >>> 0).toString(36); },

            // [Optimized] åŠ è½½ Layout å¹¶æ ¡éªŒä¸€è‡´æ€§ (æ”¯æŒå›è°ƒä»¥ç¡®ä¿é¡ºåº)
            loadAndCheckLayout: function (currentCsvHash, callback) {
                let loaded = false;
                try {
                    // [Fix] ä¸æŒ‡å®šç‰ˆæœ¬å·ï¼Œæ‰“å¼€å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼Œé˜²æ­¢å›  optimizer å‡çº§ç‰ˆæœ¬å¯¼è‡´ index.html æ— æ³•æ‰“å¼€
                    const req = indexedDB.open("EastAsiaHistoryDB");
                    req.onerror = (e) => {
                        console.warn("âŒ DB Open Failed:", e.target.error);
                        if (callback) callback();
                    };
                    req.onsuccess = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains("layouts")) { if (callback) callback(); return; }
                        const tx = db.transaction("layouts", "readonly");
                        const store = tx.objectStore("layouts");
                        const getReq = store.get("current");
                        getReq.onsuccess = () => {
                            const rec = getReq.result;
                            if (rec && rec.data) {
                                // 1. ä¿å­˜åˆ° State
                                this.state.layoutData = rec.data;
                                console.log("âœ… Layout loaded from DB");

                                // 2. æ ¡éªŒ Hash (ä»…å½“æä¾›äº†å½“å‰Hashæ—¶)
                                if (currentCsvHash && rec.data.dataHash && rec.data.dataHash !== currentCsvHash) {
                                    this.showDesyncAlert();
                                }
                            }
                            // æ— è®ºæˆåŠŸä¸å¦ï¼Œåªè¦ DB æ“ä½œç»“æŸï¼Œå°±æ‰§è¡Œå›è°ƒï¼ˆç”¨äºè§¦å‘ processDataï¼‰
                            if (callback) callback();

                            // 3. å¦‚æœæ˜¯å¼‚æ­¥æ›´æ–°ä¸”æ•°æ®å·²å°±ç»ªï¼Œå†æ¬¡å¹¿æ’­
                            if (!callback && this.state.dataReady) {
                                this.broadcastData();
                            }
                        };
                        getReq.onerror = () => { if (callback) callback(); };
                    };
                } catch (e) {
                    console.warn("IndexDB check failed", e);
                    if (callback) callback();
                }
            },

            // [New] æ˜¾ç¤º SOP æŠ¥è­¦
            showDesyncAlert: function () {
                // ... (Previous logic remains, implicitly handled by not replacing checking logic if I guard lines correctly)
                // Wait, I need to be careful not to delete showDesyncAlert.
                // I will target checkLayoutSync only.
            },
            showDesyncAlert: function () {
                const msg = `
                    <div style="text-align:left; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <p style="color:#fbbf24; font-weight:bold; font-size:16px; margin-bottom:8px">âš ï¸ æ•°æ®æºç‰ˆæœ¬ä¸ä¸€è‡´</p>
                        <p style="margin-bottom:8px">æ£€æµ‹åˆ° CSV æ•°æ®æºå·²æ›´æ–°ï¼Œä½† Layout å¸ƒå±€æ•°æ®ä»ä¸ºæ—§ç‰ˆã€‚</p>
                        <p style="margin-bottom:12px; font-size:12px; opacity:0.8">è¿™ä¼šå¯¼è‡´å…¨æ™¯å›¾æ˜¾ç¤ºé”™ä¹± (Fall back to full width)ã€‚</p>
                        <div style="background:rgba(255,255,255,0.1); padding:12px; border-radius:6px; border:1px solid rgba(255,255,255,0.1)">
                            <p style="font-weight:bold; margin-bottom:8px; color:#4ade80">ğŸ› ï¸ æ ‡å‡†ä¿®å¤æµç¨‹ (SOP):</p>
                            <ol style="padding-left:20px; line-height:1.6; margin:0; font-size:13px">
                                <li>æ‰“å¼€ <a href="LayoutOptimizer.html" target="_blank" style="color:#60a5fa; text-decoration:underline">LayoutOptimizer</a></li>
                                <li>ç‚¹å‡» "â˜ï¸ äº‘ç«¯æ•°æ®" åŠ è½½æœ€æ–° CSV</li>
                                <li>ç‚¹å‡» "Run" é‡æ–°è®¡ç®—å¸ƒå±€</li>
                                <li>ç‚¹å‡» "ğŸ’¾ å†™å…¥ DB" å­˜å…¥æ–° Hash</li>
                                <li>åˆ·æ–°æœ¬é¡µé¢</li>
                            </ol>
                        </div>
                    </div>
                `;
                // ä½¿ç”¨ GlobalUtils.showToast ä½†è®¾ç½®è¶…é•¿æ—¶é—´ï¼Œæˆ–è€…é€ ä¸€ä¸ª Modal
                // è¿™é‡Œä¸ºäº†æ˜¾çœ¼ï¼Œç›´æ¥è¦†ç›–ä¸€ä¸ªå…¨å±é®ç½©æˆ–è€…ç”¨ç‰¹å®šçš„ Alert UI
                // æˆ‘ä»¬å¤ç”¨ showToast ä½†è‡ªå®šä¹‰æ ·å¼
                const container = document.getElementById('global-toast-container') || document.body;
                const div = document.createElement('div');
                div.innerHTML = msg;
                div.style.cssText = 'position:fixed; top:80px; right:20px; width:360px; background:#1e293b; color:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.6); border:2px solid #f59e0b; z-index:999999; animation: slideIn 0.3s ease-out;';

                // Add Close Button
                const close = document.createElement('span');
                close.innerHTML = 'Ã—';
                close.style.cssText = 'position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; opacity:0.6;';
                close.onclick = () => div.remove();
                div.appendChild(close);

                container.appendChild(div);
            },

            loadLocal: function (updateLog) {
                Papa.parse(this.config.localCsv, {
                    download: true, header: true, skipEmptyLines: true,
                    transform: (val) => val.trim(), // [Fix] Trim whitespace
                    complete: (results) => {
                        console.log(`âœ… Local Data Loaded: ${results.data.length} records`);
                        this.processData(results.data);
                    },
                    error: (err2) => {
                        console.error("âŒ All data sources failed");
                        updateLog("âŒ æ•°æ®åŠ è½½å®Œå…¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœ¬åœ°æ–‡ä»¶ã€‚");
                        alert("æ— æ³•åŠ è½½æ•°æ®ã€‚");
                    }
                });
            },

            processData: function (data) {
                this.state.rawData = data;
                this.state.dataReady = true;

                const loader = document.getElementById('global-loader');
                if (loader) {
                    loader.style.opacity = 0;
                    setTimeout(() => loader.style.display = 'none', 500);
                }

                this.broadcastData();
                this.handleUrlParams();
            },

            broadcastData: function () {
                if (!this.state.dataReady) return;
                const message = {
                    type: 'INIT_DATA',
                    payload: {
                        data: this.state.rawData,
                        sharedCSS: SHARED_CSS_STYLES,
                        layout: this.state.layoutData, // [Fix] ä¼ é€’ Layout æ•°æ®
                        config: { apiKey: this.state.apiKey }
                    }
                };

                const mapWin = document.getElementById('iframe-map')?.contentWindow;
                const panoWin = document.getElementById('iframe-panorama')?.contentWindow;

                if (this.state.framesReady.map && mapWin) mapWin.postMessage(message, window.location.origin);
                if (this.state.framesReady.panorama && panoWin) panoWin.postMessage(message, window.location.origin);
            },

            // --- æ›¿æ¢ index.html ä¸­çš„ calcColor ---
            calcColor: function (code, name) { // [New] å¢åŠ  name å‚æ•°ä»¥å¢å¼ºå“ˆå¸ŒåŒºåˆ†åº¦
                if (!code) return '#666';

                const strCode = String(code);
                let originDigit = '1';
                let eraDigit = 4;

                // [ä¿®å¤] æ™ºèƒ½åŒºåˆ† "åŒºåŸŸç¼–ç "(çº¯æ•°å­— 3ä½) ä¸ "æ”¿æƒç¼–ç "(å­—æ¯+æ•°å­—)
                if (/^\d/.test(strCode)) {
                    // Region Code (e.g. "110", "210"): é¦–ä½æ˜¯åŒºåŸŸç»„
                    originDigit = strCode.charAt(0);
                    // åŒºåŸŸå›ºå®šè‰²å½©ï¼Œä¿æŒä¸­ç­‰äº®åº¦ï¼Œé¿å…å› ç¬¬äºŒä½ ID ä¸åŒå¯¼è‡´äº®åº¦ä¹±è·³
                    eraDigit = 5;
                } else {
                    // Regime Code (e.g. "C11", "T52"): ç¬¬ä¸‰ä½æ˜¯åŒºåŸŸç»„
                    originDigit = strCode.length >= 3 ? strCode.charAt(2) : '1';
                    eraDigit = parseInt(strCode.length >= 2 ? strCode.charAt(1) : '4') || 4;
                }

                // æ–°ç‰ˆ 10 å¤§æ¿å—è‰²ç›¸å®šä¹‰ (v2.82 æœ€ç»ˆå¾®è°ƒç‰ˆ)
                const hueMap = {
                    '1': 0,   // é»„æ²³ (æ­£çº¢) - æ ¸å¿ƒåŸºå‡†
                    '5': 35,  // è¥¿åŸŸ (ç¥ç€) - [ä¿®æ”¹] 35ï¼Œé¿å¼€çº¢ä¸é»„
                    '6': 80,  // è’™å¤ (å«©è‰) - [ä¿®æ”¹] 80ï¼Œåç»¿
                    '2': 125, // é•¿æ±Ÿ (è‰ç»¿) - [ä¿®æ”¹] 125ï¼Œå›å½’æ­£ç»¿åæš–
                    '3': 170, // å—æ–¹ (é’ç¢§) - [ä¿®æ”¹] 170ï¼Œä¸é•¿æ±Ÿæ‹‰å¼€å·®è·
                    '7': 210, // ä¸œåŒ— (è”šè“) - [ä¿®æ”¹] 210ï¼Œçº¯å†·è‰²
                    '8': 245, // æœé²œ (è—é’) - [ä¿æŒ] 245
                    '4': 280, // é’è— (ç´«ç½—å…°) - [ä¿®æ”¹] 280
                    '9': 320, // æ—¥æœ¬ (æ´‹çº¢) - [ä¿®æ”¹] 320ï¼Œé¿å¼€æ­£çº¢
                    '0': 0    // å…¶ä»– (ç°)
                };
                const baseHue = hueMap[originDigit] !== undefined ? hueMap[originDigit] : 0;

                // [Enhanced Hash] æ··åˆ Name å’Œ Code ä»¥äº§ç”Ÿæœ€å¤§å·®å¼‚
                let seedStr = code;
                if (name) seedStr += name;

                let hash = 0;
                for (let i = 0; i < seedStr.length; i++) hash = seedStr.charCodeAt(i) + ((hash << 5) - hash);
                hash = Math.abs(hash);

                // [Perturbation Improved] 
                // 1. Hue: åŒææ€§åç§» (Bipolar Shift)
                // å¼ºåˆ¶åç§»é‡è‡³å°‘ä¸º 3 åº¦ï¼ŒèŒƒå›´ [-8, -3] æˆ– [3, 8]
                // é»˜è®¤éšæœºæ–¹å‘
                let hueDir = (hash % 2 === 0) ? 1 : -1;
                if (name && /[ä¸œå‰å·¦ä¸Š]/.test(name)) hueDir = 1;
                if (name && /[è¥¿åå³ä¸‹]/.test(name)) hueDir = -1;

                // å…è®¸ 0 åº¦åç§»ï¼Œå……åˆ†åˆ©ç”¨ 0-8 åº¦ç©ºé—´
                const hueMag = hash % 9;
                const hueShift = hueDir * hueMag;

                let h = baseHue + hueShift;
                if (h < 0) h += 360;

                // 2. Lightness: åŸºäº Era åŸºå‡†ï¼Œå åŠ  +/- 8% çš„éšæœºæ‰°åŠ¨
                let baseL = 30 + (eraDigit * 5.0);
                // ä½¿ç”¨ä¸åŒçš„ä½è¿ç®—æ··æ·†hashï¼Œå‡å°‘hueå’Œlightnessçš„ç›¸å…³æ€§
                const lJitter = ((hash >> 2) % 17) - 8;
                // [Semantic Override] è¯­ä¹‰è¦†ç›–ï¼šå—/ä¸œ åäº®ï¼ŒåŒ—/è¥¿ åæš—
                let lBias = 0;
                if (name) {
                    if (/[å—ä¸œå‰]/.test(name)) lBias = 5;
                    if (/[åŒ—è¥¿å]/.test(name)) lBias = -5;
                }

                let l = Math.max(25, Math.min(80, baseL + lJitter + lBias)); // æ”¾å®½ä¸Šé™åˆ° 80

                // 3. Saturation: æ‰°åŠ¨ +/- 8%
                const baseSat = 45 + (eraDigit * 5);
                const satJitter = ((hash >> 4) % 17) - 8; // å³ç§»å–å¦ä¸€æ®µ hash é¿å…ç›¸å…³æ€§
                let s = Math.max(30, Math.min(95, baseSat + satJitter));

                if (originDigit === '0') return `hsl(0, 0%, ${l}%)`;
                if (originDigit === '6') { l -= 10; s -= 5; } // è’™å¤ç¨å¾®å‹æš—

                return `hsl(${h}, ${s}%, ${l}%)`;
            },

            getStyle: function (regimeCode, name, suzerainCode, suzerainType) {
                if (!regimeCode) return { bg: '#666', border: '#444', className: 'texture-C', isDashed: false };

                const selfColor = this.calcColor(regimeCode, name);
                const typeChar = regimeCode.charAt(0).toUpperCase();

                let finalBg = selfColor;
                let finalBorder = 'rgba(0,0,0,0.1)';
                let finalPattern = null;
                let className = `texture-${typeChar}`;
                let isDashed = false;

                if (suzerainCode && suzerainType) {
                    const type = suzerainType.toUpperCase();

                    if (type === 'V') {
                        className += ' texture-V';
                        finalBg = selfColor;
                        finalBorder = this.calcColor(suzerainCode);
                        isDashed = true;
                    }
                    else if (type === 'J') {
                        className = 'texture-J';
                        finalBg = this.calcColor(suzerainCode);
                        finalPattern = selfColor;
                    }
                    else if (type.includes('V') && type.includes('J')) {
                        className = 'texture-VJ';
                        const codes = suzerainCode.split('|');
                        const vCode = codes[0];
                        const jCode = codes[1] || codes[0];

                        finalBg = this.calcColor(jCode);
                        finalPattern = selfColor;
                        finalBorder = this.calcColor(vCode);
                        isDashed = true;
                    }
                }

                return {
                    bg: finalBg,
                    border: finalBorder,
                    pattern: finalPattern,
                    className: className,
                    isDashed: isDashed,
                    textColor: '#fff'
                };
            },

            switchView: function (view) {
                if (view === this.state.currentView) return;

                // ä½¿ç”¨ setState è§¦å‘è§†å›¾åˆ‡æ¢ï¼ˆå•å‘æ•°æ®æµï¼‰
                this.setState({ currentView: view });
            },

            // === UIè®¢é˜…å™¨ï¼šç›‘å¬ currentView å˜åŒ–å¹¶æ›´æ–°DOM ===
            _updateViewUI: function (newView) {
                const mapFrame = document.getElementById('iframe-map');
                const panoFrame = document.getElementById('iframe-panorama');
                const btnMap = document.getElementById('tab-map');
                const btnPano = document.getElementById('tab-pano');
                const quickNav = document.getElementById('quick-nav');

                if (newView === 'map') {
                    mapFrame.classList.add('view-active'); mapFrame.classList.remove('view-hidden');
                    panoFrame.classList.add('view-hidden'); panoFrame.classList.remove('view-active');
                    btnMap.classList.add('active'); btnPano.classList.remove('active');
                    quickNav.style.display = 'none';
                } else {
                    panoFrame.classList.add('view-active'); panoFrame.classList.remove('view-hidden');
                    mapFrame.classList.add('view-hidden'); mapFrame.classList.remove('view-active');
                    btnPano.classList.add('active'); btnMap.classList.remove('active');
                    quickNav.style.display = 'block';
                }
            },

            handleMessage: function (event) {
                const { type, payload } = event.data;
                if (!type) return;

                // === å•å‘æ•°æ®æµï¼šå­é¡µé¢è¯·æ±‚çŠ¶æ€å˜æ›´ ===
                if (type === 'STATE_UPDATE_REQUEST') {
                    // å­é¡µé¢ä¸èƒ½ç›´æ¥ä¿®æ”¹stateï¼Œåªèƒ½è¯·æ±‚çˆ¶é¡µé¢ä¿®æ”¹
                    this.setState(payload);
                    return;
                }

                if (type === 'CHILD_READY') {
                    this.log(`Child Ready: ${payload.source}`);
                    this.state.framesReady[payload.source] = true;

                    // iframeå‡†å¤‡å¥½åï¼Œç«‹å³åŒæ­¥å½“å‰çŠ¶æ€
                    this.broadcastStateSync();

                    if (this.state.dataReady) this.broadcastData();
                } else if (type === 'REQUEST_SWITCH') {
                    this.switchView(payload.target);
                    setTimeout(() => {
                        this.broadcast('CMD_JUMP', payload.params);
                    }, 100);
                }
            },

            broadcast: function (type, payload = {}) {
                this.log(`Broadcast: ${type}`);
                const frame = this.state.currentView === 'map' ? document.getElementById('iframe-map') : document.getElementById('iframe-panorama');
                if (frame && frame.contentWindow) {
                    frame.contentWindow.postMessage({ type, payload }, window.location.origin);
                }
            },

            handleSearchInput: function (val) {
                const box = document.getElementById('search-suggestions');
                if (!val || val.length < 1) { box.style.display = 'none'; return; }

                const term = val.toLowerCase();
                const seen = new Set();
                const matches = this.state.rawData.filter(r => {
                    const name = r.regime_name || r.name || "";
                    if (name.toLowerCase().includes(term) && !seen.has(name)) {
                        seen.add(name); return true;
                    }
                    return false;
                }).slice(0, 10);

                if (matches.length === 0) { box.style.display = 'none'; return; }

                box.innerHTML = matches.map(r => `
                <div class="suggestion-item" onclick="window.EastAsiaApp.executeSearch('${r.regime_name || r.name}')">
                    <span>${r.regime_name || r.name}</span>
                    <span class="suggestion-tag">${r.start_year || '?'}~${r.end_year || '?'}</span>
                </div>
            `).join('');
                box.style.display = 'block';
            },

            executeSearch: function (regimeName) {
                this.log(`Search: ${regimeName}`);
                document.getElementById('global-search').value = regimeName;
                document.getElementById('search-suggestions').style.display = 'none';

                const target = this.state.rawData.find(r => (r.regime_name === regimeName || r.name === regimeName));
                if (target) {
                    if (this.state.currentView === 'panorama') {
                        this.broadcast('CMD_JUMP', { regime: regimeName, year: target.start_year });
                    } else {
                        this.broadcast('CMD_JUMP', {
                            regime: regimeName,
                            region: target.geo_code,
                            year: target.start_year,
                            showDetails: true
                        });
                    }
                }
            },

            updateButtonStates: function () {
                const btnA = document.getElementById('btn-antique');
                if (btnA) btnA.innerText = this.state.features.antique ? "ğŸ“œ ä»¿å¤å·²å¼€" : "ğŸ“œ ä»¿å¤å·²å…³";

                const btnB = document.getElementById('btn-borders');
                if (btnB) btnB.innerText = this.state.features.borders ? "ğŸ—ºï¸ çœç•Œå·²å¼€" : "ğŸ—ºï¸ çœç•Œå·²å…³";

                const btnC = document.getElementById('btn-connections');
                if (btnC) btnC.innerText = this.state.features.connections ? "ğŸ”— çº½å¸¦å·²å¼€" : "ğŸ”— çº½å¸¦å·²å…³";
            },

            toggleAntique: function () {
                this.state.features.antique = !this.state.features.antique;
                this.updateButtonStates();
                this.broadcast('CMD_TOGGLE_ANTIQUE');
            },

            toggleBorders: function () {
                this.state.features.borders = !this.state.features.borders;
                this.updateButtonStates();
                this.broadcast('CMD_TOGGLE_BORDERS');
            },

            toggleConnections: function () {
                this.state.features.connections = !this.state.features.connections;
                this.updateButtonStates();

                if (this.state.currentView !== 'panorama' && this.state.features.connections) {
                    this.switchView('panorama');
                }
                setTimeout(() => {
                    const pano = document.getElementById('iframe-panorama');
                    if (pano && pano.contentWindow) {
                        pano.contentWindow.postMessage({ type: 'CMD_TOGGLE_FEATURE', payload: 'connections' }, window.location.origin);
                    }
                }, 200);
            },

            handleUrlParams: function () {
                const p = new URLSearchParams(window.location.search);
                // æ£€æŸ¥æ˜¯å¦æœ‰ year æˆ– regime å‚æ•°
                if (p.get('year') || p.get('regime')) {
                    // å»¶è¿Ÿä¸€ç‚¹å¹¿æ’­ï¼Œç¡®ä¿å­é¡µé¢å·²åŠ è½½
                    setTimeout(() => {
                        this.broadcast('CMD_JUMP', {
                            year: p.get('year'),
                            region: p.get('region'),
                            regime: p.get('regime')
                        });
                    }, 1000);
                }
            },

            clearCache: function () {
                if (confirm("âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ï¼š\n1. æœ¬åœ°å­˜å‚¨çš„å†å²æ•°æ®\n2. ä¿å­˜çš„ Gemini API Key\n3. å¸ƒå±€ä¼˜åŒ–ç¼“å­˜ (IndexedDB)\n4. ç‰ˆæœ¬å·ç¼“å­˜\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚")) {
                    try {
                        // 1. æ¸…ç† localStorage
                        localStorage.removeItem(this.config.cacheKey);
                        localStorage.removeItem(this.config.apiKeyStorage);
                        localStorage.removeItem('APP_VERSION');

                        // 2. æ¸…ç† IndexedDB (å¸ƒå±€æ•°æ®)
                        const dbNames = ['EastAsiaHistoryDB', 'EastAsiaLayoutDB'];
                        dbNames.forEach(name => {
                            try {
                                indexedDB.deleteDatabase(name);
                                console.log(`ğŸ—‘ï¸ Deleted IndexedDB: ${name}`);
                            } catch (e) {
                                console.warn(`Failed to delete ${name}:`, e);
                            }
                        });

                        // 3. æ¸…ç† Service Worker ç¼“å­˜ (å¦‚æœ‰)
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => caches.delete(name));
                            });
                        }

                        alert("âœ… æ‰€æœ‰ç¼“å­˜å·²æˆåŠŸæ¸…é™¤ã€‚");
                        location.reload(true); // å¼ºåˆ¶åˆ·æ–°ï¼Œç»•è¿‡æµè§ˆå™¨ç¼“å­˜
                    } catch (e) {
                        console.error("Clear cache failed:", e);
                        alert("æ¸…é™¤ç¼“å­˜æ—¶å‡ºé”™ï¼š" + e.message);
                    }
                }
            },

            // åœ¨ index.html çš„ EastAsiaApp å¯¹è±¡å†…
            resetAll: function () {
                console.log("ğŸš€ ä¸»é¡µå‘å‡ºå¼ºåŠ›å¤ä½æŒ‡ä»¤...");

                // 1. æ¸…ç©ºæœç´¢æ¡†
                const searchInput = document.getElementById('global-search');
                if (searchInput) searchInput.value = '';
                document.querySelector('.search-container').classList.remove('active');
                document.getElementById('search-suggestions').style.display = 'none';

                // 2. å‘é€æŒ‡ä»¤ç»™æ‰€æœ‰å­é¡µé¢
                const frames = document.querySelectorAll('iframe');
                frames.forEach(frame => {
                    if (frame.contentWindow) {
                        frame.contentWindow.postMessage({ type: 'CMD_RESET' }, window.location.origin);
                    }
                });

                // 3. æç¤ºç”¨æˆ·
                // (å¯é€‰) alert("ç³»ç»Ÿå·²å¤ä½"); 
            },
        };

        window.EastAsiaApp.init();
    </script>
</body>

</html>